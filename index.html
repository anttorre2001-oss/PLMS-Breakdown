<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLMS breakdown</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & DOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;
        const { 
            ResponsiveContainer, ComposedChart, Bar, Line, XAxis, YAxis, 
            Tooltip, CartesianGrid, Legend 
        } = Recharts;

        // --- Icons ---
        const Icons = {
            Filter: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            FileUp: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="m9 15 3-3 3 3"/></svg>,
            Sparkles: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
            AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Clipboard: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>,
            Check: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="20 6 9 17 4 12"/></svg>
        };

        // --- Config & Constants ---
        const LINE_TABS = ["Line A", "Line B", "Line C", "Line D"];

        const LINE_COLOR = {
            "LINE A": "#3b82f6", // blue
            "LINE B": "#10b981", // green
            "LINE C": "#f59e0b", // orange
            "LINE D": "#8b5cf6", // purple
            "UNKNOWN": "#64748b", // slate
        };

        const COST_PER_HOUR = {
            "LINE A": 1003.5,
            "LINE B": 1003.5,
            "LINE C": 1299.33,
            "LINE D": 1299.33,
        };

        // --- Helpers ---
        function round(n, dp = 2) { const p = Math.pow(10, dp); return Math.round(n * p) / p; }
        function fmtMoney(n) { return n.toLocaleString(undefined, { style: "currency", currency: "USD" }); }
        function fmtHoursFromMin(min) { return `${round(min / 60, 2).toLocaleString()} h`; }
        function fmtMin(min) { return `${round(min, 0).toLocaleString()} min`; }
        function toISODate(d) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, "0");
            const day = String(d.getDate()).padStart(2, "0");
            return `${y}-${m}-${day}`;
        }

        function tryParseNumber(s) {
            if (s == null) return null;
            const cleaned = String(s).trim().replace(/,/g, "").replace(/^\+/, "");
            if (!cleaned) return null;
            const n = Number(cleaned);
            return Number.isFinite(n) ? n : null;
        }

        function excelSerialToDate(serial) {
            const base = new Date(Date.UTC(1899, 11, 30));
            const ms = serial * 86400 * 1000;
            return new Date(base.getTime() + ms);
        }

        function tryParseDate(value) {
            if (!value) return null;
            const v = String(value).trim();
            const maybeNum = tryParseNumber(v);
            if (maybeNum != null && maybeNum > 20000 && maybeNum < 80000) {
                const d = excelSerialToDate(maybeNum);
                if (!Number.isNaN(d.getTime())) return d;
            }
            const d1 = new Date(v);
            if (!Number.isNaN(d1.getTime())) return d1;
            return null;
        }

        function normalizeLine(v) {
            const s = String(v || "").trim().toUpperCase();
            if (!s) return "UNKNOWN";
            if (s.startsWith("A") || s.includes("LINE A")) return "LINE A";
            if (s.startsWith("B") || s.includes("LINE B")) return "LINE B";
            if (s.startsWith("C") || s.includes("LINE C")) return "LINE C";
            if (s.startsWith("D") || s.includes("LINE D")) return "LINE D";
            return s.startsWith("LINE ") ? s : "UNKNOWN";
        }

        function safeEventName(v) {
            const s = String(v || "").trim();
            return s ? (s.length > 120 ? s.slice(0, 117) + "…" : s) : "(Unspecified)";
        }

        function computeRowCostUSD(row) {
            const cph = COST_PER_HOUR[row.line] ?? 0;
            return (row.downtimeMin / 60) * cph;
        }

        // --- Parsing Logic ---
        function parseDelimited(text) {
            const normalized = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
            const lines = normalized.split("\n").filter(l => l.trim().length > 0);
            if (lines.length === 0) return { headers: [], rows: [] };

            const delim = text.includes("\t") ? "\t" : ","; 

            const splitLine = (line) => {
                if (delim === "\t") return line.split("\t");
                const out = [];
                let cur = "";
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const ch = line[i];
                    if (ch === '"') {
                        if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; } 
                        else { inQuotes = !inQuotes; }
                    } else if (ch === "," && !inQuotes) {
                        out.push(cur); cur = "";
                    } else { cur += ch; }
                }
                out.push(cur);
                return out;
            };

            const headers = splitLine(lines[0]).map(h => h.trim());
            const rows = lines.slice(1).map(l => splitLine(l).map(c => c.trim()));
            return { headers, rows };
        }

        function buildRows(text) {
            const warnings = [];
            const { headers, rows } = parseDelimited(text);
            if (headers.length === 0) return { data: [], warnings: [] };

            const norm = headers.map(h => h.toLowerCase().replace(/[^a-z0-9]/g, ""));
            const findCol = (keys) => norm.findIndex(h => keys.some(k => h.includes(k)));

            const dateIdx = findCol(["date", "time", "timestamp"]);
            const lineIdx = findCol(["line", "asset", "machine"]);
            const eventIdx = findCol(["event", "reason", "fault", "stop"]);
            const durationIdx = findCol(["duration", "downtime", "min", "minutes"]);

            if (dateIdx === -1) warnings.push("Missing 'Date' column.");
            if (lineIdx === -1) warnings.push("Missing 'Line' column.");
            if (eventIdx === -1) warnings.push("Missing 'Event/Reason' column.");
            if (durationIdx === -1) warnings.push("Missing 'Duration' column.");

            const data = [];
            rows.forEach((row, i) => {
                const dt = dateIdx >= 0 ? tryParseDate(row[dateIdx]) : null;
                const line = lineIdx >= 0 ? normalizeLine(row[lineIdx]) : "UNKNOWN";
                const event = eventIdx >= 0 ? safeEventName(row[eventIdx]) : "(Unspecified)";
                let downtimeMin = 0;
                if (durationIdx >= 0) {
                    const n = tryParseNumber(row[durationIdx]);
                    downtimeMin = n != null ? Math.max(0, n) : 0;
                }

                if (!dt && line === "UNKNOWN" && downtimeMin === 0) return;

                data.push({
                    id: i,
                    dt,
                    dateISO: dt ? toISODate(dt) : null,
                    line,
                    event,
                    downtimeMin
                });
            });

            return { data, warnings };
        }

        // --- Main Component ---
        function App() {
            const [rawText, setRawText] = useState("");
            const [data, setData] = useState([]);
            const [warnings, setWarnings] = useState([]);
            const [activeTab, setActiveTab] = useState("Line A");
            const [dateFrom, setDateFrom] = useState("");
            const [dateTo, setDateTo] = useState("");
            const [selectedEvent, setSelectedEvent] = useState(null);
            const [search, setSearch] = useState("");
            const [isPasteModalOpen, setIsPasteModalOpen] = useState(false);
            
            const fileInputRef = useRef(null);

            // Analysis
            const handleAnalyze = (text) => {
                const built = buildRows(text);
                setData(built.data);
                setWarnings(built.warnings);
                setRawText(text); // Store raw text logic but hide UI
                setIsPasteModalOpen(false); // Close modal if open

                // Auto-set dates
                if (built.data.length > 0) {
                    const dates = built.data.filter(r => r.dt).map(r => r.dt.getTime());
                    if (dates.length > 0) {
                        setDateFrom(toISODate(new Date(Math.min(...dates))));
                        setDateTo(toISODate(new Date(Math.max(...dates))));
                    }
                }
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const text = await file.text();
                handleAnalyze(text);
                e.target.value = ''; // Reset input
            };

            // Filtering
            const filtered = useMemo(() => {
                const from = dateFrom ? new Date(dateFrom + "T00:00:00") : null;
                const to = dateTo ? new Date(dateTo + "T23:59:59") : null;
                const activeLine = normalizeLine(activeTab);

                return data.filter(r => {
                    if (r.line !== activeLine) return false;
                    if (from && r.dt < from) return false;
                    if (to && r.dt > to) return false;
                    if (selectedEvent && r.event !== selectedEvent) return false;
                    if (search) {
                        const hay = `${r.event} ${r.line}`.toLowerCase();
                        if (!hay.includes(search.toLowerCase())) return false;
                    }
                    return true;
                }).sort((a, b) => (b.dt?.getTime() || 0) - (a.dt?.getTime() || 0));
            }, [data, activeTab, dateFrom, dateTo, selectedEvent, search]);

            // KPIs
            const totals = useMemo(() => {
                const totalMin = filtered.reduce((s, r) => s + r.downtimeMin, 0);
                const totalCost = filtered.reduce((s, r) => s + computeRowCostUSD(r), 0);
                return { totalMin, totalCost, count: filtered.length };
            }, [filtered]);

            // Aggregations
            const byEvent = useMemo(() => {
                const map = {};
                filtered.forEach(r => {
                    if (!map[r.event]) map[r.event] = { event: r.event, min: 0, cost: 0, count: 0 };
                    map[r.event].min += r.downtimeMin;
                    map[r.event].cost += computeRowCostUSD(r);
                    map[r.event].count++;
                });
                const sorted = Object.values(map).sort((a, b) => b.min - a.min);
                let cum = 0;
                return sorted.map(d => {
                    cum += d.min;
                    return {
                        ...d,
                        hours: d.min / 60,
                        pct: (d.min / totals.totalMin) * 100 || 0,
                        cumPct: (cum / totals.totalMin) * 100 || 0
                    };
                });
            }, [filtered, totals.totalMin]);

            // Insights Generator
            const insights = useMemo(() => {
                const msgs = [];
                if (totals.totalMin === 0) return ["No data for current filters."];
                
                const top = byEvent[0];
                if (top) msgs.push(`Primary Bottleneck: “${top.event}” causes ${round(top.pct, 1)}% of all downtime (${fmtHoursFromMin(top.min)}, ${fmtMoney(top.cost)}).`);
                
                msgs.push(`Financial Impact: Total estimated loss of ${fmtMoney(totals.totalCost)} in this window.`);
                return msgs;
            }, [byEvent, totals]);

            // Render Helpers
            const TabButton = ({ name, isActive, onClick }) => (
                <button 
                    onClick={onClick}
                    className={`px-5 py-2.5 rounded-full text-sm font-semibold transition-all ${isActive ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                >
                    {name}
                </button>
            );

            return (
                <div className="min-h-screen p-6 max-w-[1600px] mx-auto pb-20">
                    
                    {/* TOP NAVIGATION & LINE SELECTION */}
                    <div className="flex flex-col gap-6 mb-8">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-b border-slate-800 pb-6">
                            <div>
                                <h1 className="text-4xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">PLMS breakdown</h1>
                                <p className="text-slate-400 text-sm mt-1">Production Line Management System</p>
                            </div>

                            {/* Line Selection at Top */}
                            <div className="flex gap-2 overflow-x-auto">
                                {LINE_TABS.map(t => (
                                    <TabButton key={t} name={t} isActive={activeTab === t} onClick={() => setActiveTab(t)} />
                                ))}
                            </div>
                        </div>

                        {/* Data Input Actions - Look like file uploads */}
                        <div className="flex justify-end items-center gap-3">
                            {data.length > 0 && (
                                <div className="flex items-center gap-2 bg-emerald-500/10 border border-emerald-500/20 px-3 py-1.5 rounded-md text-emerald-400 text-xs font-medium mr-2">
                                    <Icons.Check className="w-3 h-3"/> Data Loaded: {data.length} rows
                                </div>
                            )}

                            <button onClick={() => setIsPasteModalOpen(true)} className="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 px-4 py-2 rounded-lg text-sm text-slate-200 transition-colors shadow-sm">
                                <Icons.Clipboard className="w-4 h-4" /> Paste Data
                            </button>
                            
                            <input type="file" ref={fileInputRef} className="hidden" accept=".csv,.txt" onChange={handleFileUpload} />
                            <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 px-4 py-2 rounded-lg text-sm text-slate-200 transition-colors shadow-sm">
                                <Icons.FileUp className="w-4 h-4" /> Upload CSV
                            </button>
                            
                            {data.length > 0 && (
                                <button onClick={() => { setRawText(""); setData([]); }} className="flex items-center gap-2 bg-red-900/20 hover:bg-red-900/40 border border-red-900/30 px-4 py-2 rounded-lg text-sm text-red-300 transition-colors">
                                    <Icons.X className="w-4 h-4" /> Clear
                                </button>
                            )}
                        </div>
                    </div>

                    {/* SEPARATE FILTERS BAR */}
                    <div className="bg-slate-900 border border-slate-800 rounded-xl p-4 mb-8 flex flex-wrap gap-6 items-end">
                        <div className="flex items-center gap-2 text-indigo-400 font-semibold mb-1 mr-4">
                            <Icons.Filter className="w-5 h-5"/> 
                            <span>Filters</span>
                        </div>
                        
                        <div>
                            <label className="text-xs text-slate-500 block mb-1.5 uppercase font-bold tracking-wider">Date From</label>
                            <input type="date" value={dateFrom} onChange={e => setDateFrom(e.target.value)} className="bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none" />
                        </div>
                        
                        <div>
                            <label className="text-xs text-slate-500 block mb-1.5 uppercase font-bold tracking-wider">Date To</label>
                            <input type="date" value={dateTo} onChange={e => setDateTo(e.target.value)} className="bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none" />
                        </div>
                        
                        <div className="flex-grow min-w-[200px]">
                            <label className="text-xs text-slate-500 block mb-1.5 uppercase font-bold tracking-wider">Search Event</label>
                            <input type="text" value={search} onChange={e => setSearch(e.target.value)} placeholder="Filter by keyword..." className="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none" />
                        </div>
                    </div>

                    {/* SEPARATE KPI ROW */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                        <div className="bg-slate-900 border border-slate-800 p-5 rounded-xl shadow-lg relative overflow-hidden group">
                            <div className="absolute top-0 right-0 w-20 h-20 bg-indigo-500/10 rounded-bl-full group-hover:bg-indigo-500/20 transition-all"></div>
                            <p className="text-sm font-medium text-slate-400 mb-1">Total Downtime</p>
                            <p className="text-3xl font-bold text-white">{fmtHoursFromMin(totals.totalMin)}</p>
                        </div>
                        <div className="bg-slate-900 border border-slate-800 p-5 rounded-xl shadow-lg relative overflow-hidden group">
                            <div className="absolute top-0 right-0 w-20 h-20 bg-emerald-500/10 rounded-bl-full group-hover:bg-emerald-500/20 transition-all"></div>
                            <p className="text-sm font-medium text-slate-400 mb-1">Estimated Cost</p>
                            <p className="text-3xl font-bold text-emerald-400">{fmtMoney(totals.totalCost)}</p>
                        </div>
                        <div className="bg-slate-900 border border-slate-800 p-5 rounded-xl shadow-lg relative overflow-hidden group">
                            <div className="absolute top-0 right-0 w-20 h-20 bg-blue-500/10 rounded-bl-full group-hover:bg-blue-500/20 transition-all"></div>
                            <p className="text-sm font-medium text-slate-400 mb-1">Event Count</p>
                            <p className="text-3xl font-bold text-white">{totals.count}</p>
                        </div>
                        <div className="bg-slate-900 border border-slate-800 p-5 rounded-xl shadow-lg relative overflow-hidden group">
                            <div className="absolute top-0 right-0 w-20 h-20 bg-amber-500/10 rounded-bl-full group-hover:bg-amber-500/20 transition-all"></div>
                            <p className="text-sm font-medium text-slate-400 mb-1">Top Cause Share</p>
                            <p className="text-3xl font-bold text-amber-400">{byEvent[0] ? round(byEvent[0].pct,1) : 0}%</p>
                        </div>
                    </div>

                    {/* MAIN CONTENT GRID */}
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        {/* LEFT COLUMN: Chart & Insights */}
                        <div className="lg:col-span-8 space-y-6">
                            
                            {/* Pareto Chart */}
                            <div className="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-lg h-[500px]">
                                <h4 className="text-lg font-semibold text-slate-200 mb-6 flex justify-between items-center">
                                    Pareto Analysis: Top Events
                                    <span className="text-xs font-normal text-slate-500 bg-slate-950 px-2 py-1 rounded border border-slate-800">By Duration</span>
                                </h4>
                                <ResponsiveContainer width="100%" height="90%">
                                    <ComposedChart data={byEvent.slice(0, 12)} margin={{top:0, left:0, right:0, bottom:60}}>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                                        <XAxis 
                                            dataKey="event" 
                                            stroke="#94a3b8" 
                                            fontSize={11} 
                                            angle={-45} 
                                            textAnchor="end" 
                                            height={80}
                                            interval={0}
                                        />
                                        <YAxis yAxisId="left" stroke="#94a3b8" fontSize={11} />
                                        <YAxis yAxisId="right" orientation="right" stroke="#94a3b8" fontSize={11} domain={[0, 100]} unit="%" />
                                        <Tooltip 
                                            contentStyle={{backgroundColor: '#0f172a', borderColor: '#334155', color: '#f1f5f9', borderRadius: '8px'}} 
                                            itemStyle={{fontSize: '12px'}}
                                            labelStyle={{fontWeight: 'bold', color: '#cbd5e1', marginBottom: '5px'}}
                                        />
                                        <Legend verticalAlign="top" height={36}/>
                                        <Bar yAxisId="left" dataKey="hours" name="Hours Lost" fill="#6366f1" radius={[4,4,0,0]} barSize={40} />
                                        <Line yAxisId="right" type="monotone" dataKey="cumPct" name="Cumulative %" stroke="#f59e0b" strokeWidth={2} dot={{fill: '#f59e0b', r: 3}} activeDot={{r: 5}} />
                                    </ComposedChart>
                                </ResponsiveContainer>
                            </div>

                            {/* Event Log */}
                            <div className="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-lg">
                                <div className="p-4 border-b border-slate-800 bg-slate-950/50 flex justify-between items-center">
                                    <h4 className="font-semibold text-slate-300">Detailed Event Log</h4>
                                    <span className="text-xs text-slate-500">{filtered.length} records</span>
                                </div>
                                <div className="overflow-x-auto max-h-[400px]">
                                    <table className="w-full text-sm text-left">
                                        <thead className="text-xs text-slate-400 uppercase bg-slate-950 sticky top-0">
                                            <tr>
                                                <th className="px-6 py-3">Date</th>
                                                <th className="px-6 py-3">Event</th>
                                                <th className="px-6 py-3 text-right">Duration</th>
                                                <th className="px-6 py-3 text-right">Cost</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-800">
                                            {filtered.slice(0, 200).map((r) => (
                                                <tr key={r.id} className="hover:bg-slate-800/50 transition-colors">
                                                    <td className="px-6 py-3 font-mono text-slate-400">{r.dateISO || "-"}</td>
                                                    <td className="px-6 py-3 text-slate-200">{r.event}</td>
                                                    <td className="px-6 py-3 text-right font-mono text-slate-300">{fmtMin(r.downtimeMin)}</td>
                                                    <td className="px-6 py-3 text-right font-mono text-emerald-400">{fmtMoney(computeRowCostUSD(r))}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        {/* RIGHT COLUMN: Lists & Insights */}
                        <div className="lg:col-span-4 space-y-6">
                            
                            {/* Insights Box */}
                            <div className="bg-gradient-to-br from-indigo-900/40 to-slate-900 border border-indigo-500/30 rounded-xl p-5 shadow-inner">
                                <h3 className="text-indigo-400 font-semibold mb-4 flex items-center gap-2">
                                    <Icons.Sparkles className="w-4 h-4"/> AI Insights
                                </h3>
                                <div className="space-y-3">
                                    {insights.map((msg, i) => (
                                        <div key={i} className="text-sm text-slate-300 bg-slate-950/50 p-3 rounded-lg border border-slate-800/50">
                                            {msg}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Top 5 Drilldown */}
                            <div className="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-lg">
                                <div className="p-4 border-b border-slate-800 bg-slate-950/50 flex justify-between items-center">
                                    <h4 className="font-semibold text-slate-300">Top 5 Offenders</h4>
                                    <span className="text-xs text-slate-500">Click to filter</span>
                                </div>
                                <div className="divide-y divide-slate-800">
                                    {byEvent.slice(0, 5).map((e, idx) => (
                                        <div key={idx} 
                                             onClick={() => setSelectedEvent(selectedEvent === e.event ? null : e.event)}
                                             className={`p-4 hover:bg-slate-800/50 cursor-pointer transition-colors ${selectedEvent === e.event ? 'bg-indigo-900/20 border-l-4 border-indigo-500' : ''}`}
                                        >
                                            <div className="flex justify-between items-start">
                                                <div className="flex gap-3">
                                                    <span className="flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-full bg-slate-800 text-xs text-slate-400 font-mono">
                                                        {idx + 1}
                                                    </span>
                                                    <div>
                                                        <p className="font-medium text-slate-200 text-sm leading-tight">{e.event}</p>
                                                        <p className="text-xs text-slate-500 mt-1">{e.count} stops</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className="font-bold text-white text-sm">{fmtHoursFromMin(e.min)}</p>
                                                    <p className="text-xs text-slate-500">{round(e.pct, 1)}%</p>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    {byEvent.length === 0 && <div className="p-8 text-center text-slate-500 text-sm">No events found</div>}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Paste Modal Overlay */}
                    {isPasteModalOpen && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in">
                            <div className="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden">
                                <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-950">
                                    <h3 className="font-semibold text-slate-200">Paste Raw Data</h3>
                                    <button onClick={() => setIsPasteModalOpen(false)} className="text-slate-500 hover:text-white"><Icons.X className="w-5 h-5"/></button>
                                </div>
                                <div className="p-6">
                                    <textarea 
                                        id="pasteArea"
                                        placeholder="Paste Excel data here (headers required)..."
                                        className="w-full h-64 bg-slate-950 border border-slate-800 rounded-xl p-4 text-xs font-mono text-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none resize-none"
                                    ></textarea>
                                    <div className="mt-4 flex justify-end gap-3">
                                        <button onClick={() => setIsPasteModalOpen(false)} className="px-4 py-2 text-slate-400 hover:text-white text-sm">Cancel</button>
                                        <button onClick={() => handleAnalyze(document.getElementById('pasteArea').value)} className="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-lg text-sm font-medium transition-all shadow-lg shadow-indigo-900/20">
                                            Analyze Data
                                        </button>
                                    </div>
                                    <p className="mt-4 text-center text-xs text-slate-500">
                                        Supports Tab-separated (Excel) or CSV. Required columns: Date, Line, Event, Duration.
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

