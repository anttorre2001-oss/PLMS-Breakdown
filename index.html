<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLMS Breakdown</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & DOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            background-color: #020617; 
            color: #f8fafc; 
            font-family: 'Inter', sans-serif; 
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        .glass-input:focus {
            border-color: rgba(99, 102, 241, 0.5);
            outline: none;
            background: rgba(0, 0, 0, 0.5);
        }

        .animate-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Print Styles */
        @media print {
            body { background: white; color: black; }
            .no-print { display: none !important; }
            .glass-panel { background: white; border: 1px solid #ddd; box-shadow: none; color: black; }
            text { fill: #000 !important; }
            .print-break { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;
        const { 
            ResponsiveContainer, ComposedChart, Bar, Line, LineChart, XAxis, YAxis, 
            Tooltip, CartesianGrid, Legend, Area, AreaChart 
        } = Recharts;

        // --- Icons ---
        const Icons = {
            Filter: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            FileUp: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="m9 15 3-3 3 3"/></svg>,
            Sparkles: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
            AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Clipboard: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>,
            Check: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="20 6 9 17 4 12"/></svg>,
            Printer: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
            Settings: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Database: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
        };

        // --- Config & Constants ---
        const LINE_TABS = ["Line A", "Line B", "Line C", "Line D"];
        const DEFAULT_COSTS = {
            "LINE A": 1003.5,
            "LINE B": 1003.5,
            "LINE C": 1299.33,
            "LINE D": 1299.33,
        };

        // --- Helpers ---
        function round(n, dp = 2) { const p = Math.pow(10, dp); return Math.round(n * p) / p; }
        function fmtMoney(n) { return n.toLocaleString(undefined, { style: "currency", currency: "USD" }); }
        function fmtHoursFromMin(min) { return `${round(min / 60, 2).toLocaleString()} h`; }
        function fmtMin(min) { return `${round(min, 0).toLocaleString()} min`; }
        function toISODate(d) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, "0");
            const day = String(d.getDate()).padStart(2, "0");
            return `${y}-${m}-${day}`;
        }
        function tryParseNumber(s) {
            if (s == null) return null;
            const cleaned = String(s).trim().replace(/,/g, "").replace(/^\+/, "");
            const n = Number(cleaned);
            return Number.isFinite(n) ? n : null;
        }
        function excelSerialToDate(serial) {
            const base = new Date(Date.UTC(1899, 11, 30));
            const ms = serial * 86400 * 1000;
            return new Date(base.getTime() + ms);
        }
        function tryParseDate(value) {
            if (!value) return null;
            const v = String(value).trim();
            const maybeNum = tryParseNumber(v);
            if (maybeNum != null && maybeNum > 20000 && maybeNum < 80000) {
                const d = excelSerialToDate(maybeNum);
                if (!Number.isNaN(d.getTime())) return d;
            }
            const d1 = new Date(v);
            if (!Number.isNaN(d1.getTime())) return d1;
            return null;
        }
        function normalizeLine(v) {
            const s = String(v || "").trim().toUpperCase();
            if (!s) return "UNKNOWN";
            if (s.startsWith("A") || s.includes("LINE A")) return "LINE A";
            if (s.startsWith("B") || s.includes("LINE B")) return "LINE B";
            if (s.startsWith("C") || s.includes("LINE C")) return "LINE C";
            if (s.startsWith("D") || s.includes("LINE D")) return "LINE D";
            return s.startsWith("LINE ") ? s : "UNKNOWN";
        }
        function safeEventName(v) {
            const s = String(v || "").trim();
            return s ? (s.length > 120 ? s.slice(0, 117) + "…" : s) : "(Unspecified)";
        }
        function computeRowCostUSD(row, costs) {
            const cph = costs[row.line] ?? 0;
            return (row.downtimeMin / 60) * cph;
        }

        // --- Parsing Logic ---
        function parseDelimited(text) {
            const normalized = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
            const lines = normalized.split("\n").filter(l => l.trim().length > 0);
            if (lines.length === 0) return { headers: [], rows: [] };
            const delim = text.includes("\t") ? "\t" : ","; 
            const splitLine = (line) => {
                if (delim === "\t") return line.split("\t");
                const out = []; let cur = ""; let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const ch = line[i];
                    if (ch === '"') {
                        if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; } else { inQuotes = !inQuotes; }
                    } else if (ch === "," && !inQuotes) {
                        out.push(cur); cur = "";
                    } else { cur += ch; }
                }
                out.push(cur); return out;
            };
            const headers = splitLine(lines[0]).map(h => h.trim());
            const rows = lines.slice(1).map(l => splitLine(l).map(c => c.trim()));
            return { headers, rows };
        }

        function buildRows(text) {
            const { headers, rows } = parseDelimited(text);
            if (headers.length === 0) return { data: [], warnings: [] };
            const norm = headers.map(h => h.toLowerCase().replace(/[^a-z0-9]/g, ""));
            const findCol = (keys) => norm.findIndex(h => keys.some(k => h.includes(k)));
            
            const dateIdx = findCol(["date", "time"]);
            const lineIdx = findCol(["line", "asset"]);
            const eventIdx = findCol(["event", "reason", "fault"]);
            const durationIdx = findCol(["duration", "downtime", "min"]);

            const warnings = [];
            if (dateIdx === -1) warnings.push("Missing 'Date' column.");
            if (lineIdx === -1) warnings.push("Missing 'Line' column.");
            if (eventIdx === -1) warnings.push("Missing 'Event/Reason' column.");
            if (durationIdx === -1) warnings.push("Missing 'Duration' column.");

            const data = [];
            rows.forEach((row, i) => {
                const dt = dateIdx >= 0 ? tryParseDate(row[dateIdx]) : null;
                const line = lineIdx >= 0 ? normalizeLine(row[lineIdx]) : "UNKNOWN";
                const event = eventIdx >= 0 ? safeEventName(row[eventIdx]) : "(Unspecified)";
                let downtimeMin = 0;
                if (durationIdx >= 0) {
                    const n = tryParseNumber(row[durationIdx]);
                    downtimeMin = n != null ? Math.max(0, n) : 0;
                }
                if (!dt && line === "UNKNOWN" && downtimeMin === 0) return;
                data.push({ id: i, dt, dateISO: dt ? toISODate(dt) : null, line, event, downtimeMin });
            });
            return { data, warnings };
        }

        // --- Demo Data Generator ---
        function generateDemoData() {
            const events = ["Motor Fault", "Jam", "No Material", "Sensor Error", "E-Stop", "Cleaning", "Changeover", "Blocked Chute", "Overload"];
            const lines = ["Line A", "Line B", "Line C", "Line D"];
            let rows = "Date\tLine\tEvent\tDuration\n";
            const now = new Date();
            for (let i = 0; i < 150; i++) {
                const dayOffset = Math.floor(Math.random() * 7);
                const d = new Date(now);
                d.setDate(d.getDate() - dayOffset);
                const dateStr = toISODate(d);
                const line = lines[Math.floor(Math.random() * lines.length)];
                const event = events[Math.floor(Math.random() * events.length)];
                // Weighted duration
                let duration = Math.floor(Math.random() * 30) + 1; 
                if (Math.random() > 0.8) duration += 60; // Occasional long stops
                rows += `${dateStr}\t${line}\t${event}\t${duration}\n`;
            }
            return rows;
        }

        // --- Animation Hook ---
        const useCountUp = (end, duration = 1000) => {
            const [count, setCount] = useState(0);
            useEffect(() => {
                let start = 0;
                const increment = end / (duration / 16);
                const timer = setInterval(() => {
                    start += increment;
                    if (start >= end) {
                        setCount(end); clearInterval(timer);
                    } else { setCount(start); }
                }, 16);
                return () => clearInterval(timer);
            }, [end, duration]);
            return count;
        };

        const AnimatedNumber = ({ value, formatter }) => {
            const count = useCountUp(value);
            return <span>{formatter ? formatter(count) : Math.round(count)}</span>;
        };

        // --- Main Component ---
        function App() {
            const [rawText, setRawText] = useState("");
            const [data, setData] = useState([]);
            const [warnings, setWarnings] = useState([]);
            const [activeTab, setActiveTab] = useState("Line A");
            const [dateFrom, setDateFrom] = useState("");
            const [dateTo, setDateTo] = useState("");
            const [selectedEvent, setSelectedEvent] = useState(null);
            const [search, setSearch] = useState("");
            const [isPasteModalOpen, setIsPasteModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [costRates, setCostRates] = useState(DEFAULT_COSTS);
            const [paretoMode, setParetoMode] = useState("duration"); // 'duration' or 'frequency'

            const fileInputRef = useRef(null);

            const handleAnalyze = (text) => {
                const built = buildRows(text);
                setData(built.data);
                setWarnings(built.warnings);
                setRawText(text);
                setIsPasteModalOpen(false);
                if (built.data.length > 0) {
                    const dates = built.data.filter(r => r.dt).map(r => r.dt.getTime());
                    if (dates.length > 0) {
                        setDateFrom(toISODate(new Date(Math.min(...dates))));
                        setDateTo(toISODate(new Date(Math.max(...dates))));
                    }
                }
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const text = await file.text();
                handleAnalyze(text);
                e.target.value = '';
            };

            const handleLoadDemo = () => handleAnalyze(generateDemoData());

            const handlePrint = () => window.print();

            // Filtering
            const filtered = useMemo(() => {
                const from = dateFrom ? new Date(dateFrom + "T00:00:00") : null;
                const to = dateTo ? new Date(dateTo + "T23:59:59") : null;
                const activeLine = normalizeLine(activeTab);

                return data.filter(r => {
                    if (r.line !== activeLine) return false;
                    if (from && r.dt < from) return false;
                    if (to && r.dt > to) return false;
                    if (selectedEvent && r.event !== selectedEvent) return false;
                    if (search) {
                        const hay = `${r.event} ${r.line}`.toLowerCase();
                        if (!hay.includes(search.toLowerCase())) return false;
                    }
                    return true;
                }).sort((a, b) => (b.dt?.getTime() || 0) - (a.dt?.getTime() || 0));
            }, [data, activeTab, dateFrom, dateTo, selectedEvent, search]);

            // KPIs
            const totals = useMemo(() => {
                const totalMin = filtered.reduce((s, r) => s + r.downtimeMin, 0);
                const totalCost = filtered.reduce((s, r) => s + computeRowCostUSD(r, costRates), 0);
                return { totalMin, totalCost, count: filtered.length };
            }, [filtered, costRates]);

            // Aggregations
            const byEvent = useMemo(() => {
                const map = {};
                filtered.forEach(r => {
                    if (!map[r.event]) map[r.event] = { event: r.event, min: 0, cost: 0, count: 0 };
                    map[r.event].min += r.downtimeMin;
                    map[r.event].cost += computeRowCostUSD(r, costRates);
                    map[r.event].count++;
                });
                
                // Sort based on toggle
                const sorted = Object.values(map).sort((a, b) => 
                    paretoMode === 'duration' ? b.min - a.min : b.count - a.count
                );

                const baseTotal = paretoMode === 'duration' ? totals.totalMin : totals.count;
                let cum = 0;
                return sorted.map(d => {
                    const val = paretoMode === 'duration' ? d.min : d.count;
                    cum += val;
                    return {
                        ...d,
                        hours: d.min / 60,
                        val: val,
                        pct: (val / baseTotal) * 100 || 0,
                        cumPct: (cum / baseTotal) * 100 || 0
                    };
                });
            }, [filtered, totals, costRates, paretoMode]);

            // Trend Chart Data
            const timelineData = useMemo(() => {
                const map = {};
                filtered.forEach(r => {
                    const d = r.dateISO || "Unknown";
                    if (!map[d]) map[d] = { date: d, min: 0, count: 0 };
                    map[d].min += r.downtimeMin;
                    map[d].count += 1;
                });
                return Object.values(map).sort((a,b) => a.date.localeCompare(b.date));
            }, [filtered]);

            // Insights
            const insights = useMemo(() => {
                const msgs = [];
                if (totals.totalMin === 0) return ["No data for current filters."];
                const top = byEvent[0];
                if (top) msgs.push(`Critical Issue: “${top.event}” is your top loss driver, accounting for ${round(top.pct, 1)}% of the total.`);
                if (timelineData.length > 1) {
                    const sortedDates = [...timelineData].sort((a,b) => b.min - a.min);
                    msgs.push(`Peak Day: Production suffered most on ${sortedDates[0].date} with ${fmtHoursFromMin(sortedDates[0].min)} lost.`);
                }
                msgs.push(`Financial Impact: Total estimated loss of ${fmtMoney(totals.totalCost)} in this window.`);
                return msgs;
            }, [byEvent, timelineData, totals]);

            const TabButton = ({ name, isActive, onClick }) => (
                <button 
                    onClick={onClick}
                    className={`px-5 py-2.5 rounded-full text-sm font-semibold transition-all shadow-md ${isActive ? 'bg-indigo-600 text-white shadow-indigo-500/40 ring-1 ring-indigo-400' : 'glass-input text-slate-400 hover:bg-white/10'}`}
                >
                    {name}
                </button>
            );

            return (
                <div className="min-h-screen p-6 max-w-[1600px] mx-auto pb-20 animate-in">
                    
                    {/* Header */}
                    <div className="flex flex-col gap-6 mb-8 no-print">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-b border-white/10 pb-6">
                            <div>
                                <h1 className="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-300 drop-shadow-sm">PLMS Breakdown</h1>
                                <p className="text-slate-400 text-sm mt-1 tracking-wide">Production Line Management System</p>
                            </div>
                            <div className="flex gap-2 overflow-x-auto">
                                {LINE_TABS.map(t => (
                                    <TabButton key={t} name={t} isActive={activeTab === t} onClick={() => setActiveTab(t)} />
                                ))}
                            </div>
                        </div>

                        {/* Controls Toolbar */}
                        <div className="flex flex-wrap justify-end items-center gap-3">
                            {data.length === 0 && (
                                <button onClick={handleLoadDemo} className="glass-panel hover:bg-white/10 text-emerald-400 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-all">
                                    <Icons.Database className="w-4 h-4" /> Load Demo Data
                                </button>
                            )}

                            {data.length > 0 && (
                                <div className="flex items-center gap-2 bg-emerald-500/10 border border-emerald-500/20 px-3 py-1.5 rounded-md text-emerald-400 text-xs font-medium mr-2">
                                    <Icons.Check className="w-3 h-3"/> Data Loaded: {data.length} rows
                                </div>
                            )}

                            <button onClick={() => setIsPasteModalOpen(true)} className="glass-panel hover:bg-white/10 px-4 py-2 rounded-lg text-sm text-slate-200 transition-all flex items-center gap-2">
                                <Icons.Clipboard className="w-4 h-4" /> Paste Data
                            </button>
                            
                            <input type="file" ref={fileInputRef} className="hidden" accept=".csv,.txt" onChange={handleFileUpload} />
                            <button onClick={() => fileInputRef.current.click()} className="glass-panel hover:bg-white/10 px-4 py-2 rounded-lg text-sm text-slate-200 transition-all flex items-center gap-2">
                                <Icons.FileUp className="w-4 h-4" /> Upload CSV
                            </button>

                            <button onClick={handlePrint} className="glass-panel hover:bg-white/10 px-4 py-2 rounded-lg text-sm text-indigo-300 transition-all flex items-center gap-2">
                                <Icons.Printer className="w-4 h-4" /> Print / PDF
                            </button>

                            <button onClick={() => setIsSettingsOpen(true)} className="glass-panel hover:bg-white/10 p-2 rounded-lg text-slate-400 transition-all">
                                <Icons.Settings className="w-5 h-5" />
                            </button>
                            
                            {data.length > 0 && (
                                <button onClick={() => { setRawText(""); setData([]); }} className="bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 px-4 py-2 rounded-lg text-sm text-red-400 transition-all flex items-center gap-2">
                                    <Icons.X className="w-4 h-4" /> Clear
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Filters Bar */}
                    <div className="glass-panel rounded-xl p-4 mb-8 flex flex-wrap gap-6 items-end no-print">
                        <div className="flex items-center gap-2 text-indigo-400 font-semibold mb-1 mr-4">
                            <Icons.Filter className="w-5 h-5"/> <span>Filters</span>
                        </div>
                        <div>
                            <label className="text-xs text-slate-500 block mb-1.5 uppercase font-bold tracking-wider">From</label>
                            <input type="date" value={dateFrom} onChange={e => setDateFrom(e.target.value)} className="glass-input rounded-lg px-3 py-2 text-sm text-slate-200 focus:ring-2 focus:ring-indigo-500 w-36" />
                        </div>
                        <div>
                            <label className="text-xs text-slate-500 block mb-1.5 uppercase font-bold tracking-wider">To</label>
                            <input type="date" value={dateTo} onChange={e => setDateTo(e.target.value)} className="glass-input rounded-lg px-3 py-2 text-sm text-slate-200 focus:ring-2 focus:ring-indigo-500 w-36" />
                        </div>
                        <div className="flex-grow min-w-[200px]">
                            <label className="text-xs text-slate-500 block mb-1.5 uppercase font-bold tracking-wider">Search</label>
                            <input type="text" value={search} onChange={e => setSearch(e.target.value)} placeholder="Search event..." className="glass-input rounded-lg px-3 py-2 text-sm text-slate-200 w-full" />
                        </div>
                    </div>

                    {/* KPIs */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8 print-break">
                        <div className="glass-panel p-5 rounded-xl relative overflow-hidden group">
                            <div className="absolute top-0 right-0 w-24 h-24 bg-indigo-500/10 rounded-bl-full group-hover:bg-indigo-500/20 transition-all blur-xl"></div>
                            <p className="text-sm font-medium text-slate-400 mb-1">Total Downtime</p>
                            <p className="text-3xl font-bold text-white tracking-tight">
                                <AnimatedNumber value={totals.totalMin / 60} formatter={(v) => `${round(v, 1)} h`} />
                            </p>
                        </div>
                        <div className="glass-panel p-5 rounded-xl relative overflow-hidden group">
                            <div className="absolute top-0 right-0 w-24 h-24 bg-emerald-500/10 rounded-bl-full group-hover:bg-emerald-500/20 transition-all blur-xl"></div>
                            <p className="text-sm font-medium text-slate-400 mb-1">Est. Cost</p>
                            <p className="text-3xl font-bold text-emerald-400 tracking-tight">
                                <AnimatedNumber value={totals.totalCost} formatter={(v) => fmtMoney(v)} />
                            </p>
                        </div>
                        <div className="glass-panel p-5 rounded-xl relative overflow-hidden group">
                            <div className="absolute top-0 right-0 w-24 h-24 bg-blue-500/10 rounded-bl-full group-hover:bg-blue-500/20 transition-all blur-xl"></div>
                            <p className="text-sm font-medium text-slate-400 mb-1">Total Stops</p>
                            <p className="text-3xl font-bold text-white tracking-tight">
                                <AnimatedNumber value={totals.count} />
                            </p>
                        </div>
                        <div className="glass-panel p-5 rounded-xl relative overflow-hidden group">
                            <div className="absolute top-0 right-0 w-24 h-24 bg-amber-500/10 rounded-bl-full group-hover:bg-amber-500/20 transition-all blur-xl"></div>
                            <p className="text-sm font-medium text-slate-400 mb-1">Top Cause %</p>
                            <p className="text-3xl font-bold text-amber-400 tracking-tight">
                                <AnimatedNumber value={byEvent[0] ? byEvent[0].pct : 0} formatter={(v) => `${round(v, 1)}%`} />
                            </p>
                        </div>
                    </div>

                    {/* Main Charts Area */}
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        {/* LEFT: Charts & Table */}
                        <div className="lg:col-span-8 space-y-6">
                            
                            {/* Pareto Chart */}
                            <div className="glass-panel rounded-xl p-6 h-[450px] print-break">
                                <div className="flex justify-between items-start mb-6">
                                    <h4 className="text-lg font-semibold text-slate-200">Pareto Analysis</h4>
                                    <div className="bg-slate-900/50 p-1 rounded-lg flex text-xs font-medium border border-white/10 no-print">
                                        <button 
                                            onClick={() => setParetoMode('duration')}
                                            className={`px-3 py-1 rounded-md transition-all ${paretoMode === 'duration' ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white'}`}
                                        >
                                            Hours Lost
                                        </button>
                                        <button 
                                            onClick={() => setParetoMode('frequency')}
                                            className={`px-3 py-1 rounded-md transition-all ${paretoMode === 'frequency' ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white'}`}
                                        >
                                            Stop Count
                                        </button>
                                    </div>
                                </div>
                                <ResponsiveContainer width="100%" height="85%">
                                    <ComposedChart data={byEvent.slice(0, 12)} margin={{top:0, left:0, right:0, bottom:40}}>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                                        <XAxis dataKey="event" stroke="#94a3b8" fontSize={11} angle={-30} textAnchor="end" height={60} interval={0} />
                                        <YAxis yAxisId="left" stroke="#94a3b8" fontSize={11} />
                                        <YAxis yAxisId="right" orientation="right" stroke="#94a3b8" fontSize={11} domain={[0, 100]} unit="%" />
                                        <Tooltip contentStyle={{backgroundColor: '#0f172a', borderColor: '#334155', color: '#f1f5f9', borderRadius: '8px'}} />
                                        <Bar yAxisId="left" dataKey={paretoMode === 'duration' ? 'hours' : 'count'} name={paretoMode === 'duration' ? 'Hours' : 'Count'} fill="#6366f1" radius={[4,4,0,0]} barSize={40} />
                                        <Line yAxisId="right" type="monotone" dataKey="cumPct" name="Cum. %" stroke="#f59e0b" strokeWidth={2} dot={false} />
                                    </ComposedChart>
                                </ResponsiveContainer>
                            </div>

                            {/* Timeline Trend */}
                            <div className="glass-panel rounded-xl p-6 h-[350px] print-break">
                                <h4 className="text-lg font-semibold text-slate-200 mb-6">Daily Downtime Trend</h4>
                                <ResponsiveContainer width="100%" height="85%">
                                    <AreaChart data={timelineData}>
                                        <defs>
                                            <linearGradient id="colorMin" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#10b981" stopOpacity={0.3}/>
                                                <stop offset="95%" stopColor="#10b981" stopOpacity={0}/>
                                            </linearGradient>
                                        </defs>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                                        <XAxis dataKey="date" stroke="#94a3b8" fontSize={11} />
                                        <YAxis stroke="#94a3b8" fontSize={11} label={{ value: 'Minutes', angle: -90, position: 'insideLeft', fill: '#64748b' }}/>
                                        <Tooltip contentStyle={{backgroundColor: '#0f172a', borderColor: '#334155', color: '#f1f5f9', borderRadius: '8px'}} />
                                        <Area type="monotone" dataKey="min" stroke="#10b981" fillOpacity={1} fill="url(#colorMin)" />
                                    </AreaChart>
                                </ResponsiveContainer>
                            </div>

                            {/* Event Log Table */}
                            <div className="glass-panel rounded-xl overflow-hidden print-break">
                                <div className="p-4 border-b border-white/10 bg-black/20 flex justify-between items-center">
                                    <h4 className="font-semibold text-slate-300">Detailed Event Log</h4>
                                    <span className="text-xs text-slate-500">{filtered.length} records</span>
                                </div>
                                <div className="overflow-x-auto max-h-[400px]">
                                    <table className="w-full text-sm text-left">
                                        <thead className="text-xs text-slate-400 uppercase bg-black/40 sticky top-0 backdrop-blur-md">
                                            <tr>
                                                <th className="px-6 py-3">Date</th>
                                                <th className="px-6 py-3">Event</th>
                                                <th className="px-6 py-3 text-right">Duration</th>
                                                <th className="px-6 py-3 text-right">Cost</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-white/5">
                                            {filtered.slice(0, 200).map((r) => {
                                                const cost = computeRowCostUSD(r, costRates);
                                                // Conditional Formatting Logic
                                                let rowClass = "hover:bg-white/5 transition-colors";
                                                let durColor = "text-slate-300";
                                                if (r.downtimeMin > 60) {
                                                    rowClass += " bg-red-500/10 hover:bg-red-500/20";
                                                    durColor = "text-red-400 font-bold";
                                                } else if (r.downtimeMin >= 30) {
                                                    rowClass += " bg-amber-500/5 hover:bg-amber-500/10";
                                                    durColor = "text-amber-400 font-bold";
                                                }
                                                return (
                                                    <tr key={r.id} className={rowClass}>
                                                        <td className="px-6 py-3 font-mono text-slate-400">{r.dateISO || "-"}</td>
                                                        <td className="px-6 py-3 text-slate-200">{r.event}</td>
                                                        <td className={`px-6 py-3 text-right font-mono ${durColor}`}>{fmtMin(r.downtimeMin)}</td>
                                                        <td className="px-6 py-3 text-right font-mono text-emerald-400">{fmtMoney(cost)}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        {/* RIGHT: Insights & Top 5 */}
                        <div className="lg:col-span-4 space-y-6">
                            
                            <div className="glass-panel border-indigo-500/30 rounded-xl p-5 relative overflow-hidden print-break">
                                <div className="absolute inset-0 bg-indigo-500/5"></div>
                                <h3 className="text-indigo-400 font-semibold mb-4 flex items-center gap-2 relative z-10">
                                    <Icons.Sparkles className="w-4 h-4"/> AI Insights
                                </h3>
                                <div className="space-y-3 relative z-10">
                                    {insights.map((msg, i) => (
                                        <div key={i} className="text-sm text-slate-300 bg-black/20 p-3 rounded-lg border border-white/5">
                                            {msg}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="glass-panel rounded-xl overflow-hidden print-break">
                                <div className="p-4 border-b border-white/10 bg-black/20 flex justify-between items-center">
                                    <h4 className="font-semibold text-slate-300">Top 5 Offenders</h4>
                                    <span className="text-xs text-slate-500">Click to filter</span>
                                </div>
                                <div className="divide-y divide-white/5">
                                    {byEvent.slice(0, 5).map((e, idx) => (
                                        <div key={idx} 
                                             onClick={() => setSelectedEvent(selectedEvent === e.event ? null : e.event)}
                                             className={`p-4 hover:bg-white/5 cursor-pointer transition-colors ${selectedEvent === e.event ? 'bg-indigo-500/20 border-l-4 border-indigo-500' : ''}`}
                                        >
                                            <div className="flex justify-between items-start">
                                                <div className="flex gap-3">
                                                    <span className="flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-full bg-white/10 text-xs text-slate-400 font-mono">
                                                        {idx + 1}
                                                    </span>
                                                    <div>
                                                        <p className="font-medium text-slate-200 text-sm leading-tight">{e.event}</p>
                                                        <p className="text-xs text-slate-500 mt-1">{e.count} stops</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className="font-bold text-white text-sm">{fmtHoursFromMin(e.min)}</p>
                                                    <p className="text-xs text-slate-500">{round(e.pct, 1)}%</p>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    {byEvent.length === 0 && <div className="p-8 text-center text-slate-500 text-sm">No events found</div>}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Modals */}
                    
                    {/* Paste Modal */}
                    {isPasteModalOpen && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in">
                            <div className="glass-panel rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden bg-[#0f172a]">
                                <div className="p-4 border-b border-white/10 flex justify-between items-center">
                                    <h3 className="font-semibold text-slate-200">Paste Raw Data</h3>
                                    <button onClick={() => setIsPasteModalOpen(false)} className="text-slate-500 hover:text-white"><Icons.X className="w-5 h-5"/></button>
                                </div>
                                <div className="p-6">
                                    <textarea 
                                        id="pasteArea"
                                        placeholder="Paste Excel data here (headers required)..."
                                        className="w-full h-64 glass-input rounded-xl p-4 text-xs font-mono text-slate-300 resize-none"
                                    ></textarea>
                                    <div className="mt-4 flex justify-end gap-3">
                                        <button onClick={() => setIsPasteModalOpen(false)} className="px-4 py-2 text-slate-400 hover:text-white text-sm">Cancel</button>
                                        <button onClick={() => handleAnalyze(document.getElementById('pasteArea').value)} className="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-lg text-sm font-medium transition-all shadow-lg shadow-indigo-900/20">
                                            Analyze Data
                                        </button>
                                    </div>
                                    <p className="mt-4 text-center text-xs text-slate-500">
                                        Supports Tab-separated (Excel) or CSV. Required columns: Date, Line, Event, Duration.
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settings Modal */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in">
                            <div className="glass-panel rounded-2xl shadow-2xl w-full max-w-md overflow-hidden bg-[#0f172a]">
                                <div className="p-4 border-b border-white/10 flex justify-between items-center">
                                    <h3 className="font-semibold text-slate-200">Configuration</h3>
                                    <button onClick={() => setIsSettingsOpen(false)} className="text-slate-500 hover:text-white"><Icons.X className="w-5 h-5"/></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <p className="text-sm text-slate-400 mb-2">Hourly Cost Rates ($)</p>
                                    {LINE_TABS.map(line => {
                                        const key = normalizeLine(line);
                                        return (
                                            <div key={line} className="flex justify-between items-center">
                                                <label className="text-sm text-slate-300">{line}</label>
                                                <input 
                                                    type="number" 
                                                    value={costRates[key]} 
                                                    onChange={(e) => setCostRates(p => ({...p, [key]: Number(e.target.value)}))}
                                                    className="glass-input rounded-md px-3 py-1 text-sm w-32 text-right" 
                                                />
                                            </div>
                                        )
                                    })}
                                    <div className="mt-6 flex justify-end">
                                        <button onClick={() => setIsSettingsOpen(false)} className="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-medium">
                                            Save Changes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

