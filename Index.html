<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OEE Downtime Insights Dashboard (HTML Prototype)</title>

    <!-- Chart.js (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
      :root {
        /* Light theme */
        --bg: #f8fafc; /* slate-50 */
        --bg2: #eef2ff; /* indigo-50 */
        --card: rgba(255, 255, 255, 0.92);
        --card2: rgba(255, 255, 255, 0.72);
        --border: rgba(15, 23, 42, 0.12); /* slate-900 */
        --border2: rgba(15, 23, 42, 0.08);
        --text: #0f172a; /* slate-900 */
        --text2: rgba(15, 23, 42, 0.82);
        --text3: rgba(15, 23, 42, 0.62);
        --muted: rgba(15, 23, 42, 0.72);
        --accent: rgba(2, 6, 23, 0.06);
        --shadow: 0 10px 25px rgba(2, 6, 23, 0.10);
        --shadow2: 0 6px 16px rgba(2, 6, 23, 0.08);
        --r: 18px;

        /* Line colors */
        --lineA: #2563eb;
        --lineB: #16a34a;
        --lineC: #f97316;
        --lineD: #a855f7;
        --unknown: #64748b;

        /* Interactive */
        --focus: rgba(37, 99, 235, 0.22);
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        color: var(--text);
        background:
          radial-gradient(1200px 800px at 15% 0%, rgba(37, 99, 235, 0.12), transparent 62%),
          radial-gradient(900px 600px at 85% 10%, rgba(168, 85, 247, 0.12), transparent 60%),
          radial-gradient(900px 700px at 40% 100%, rgba(249, 115, 22, 0.10), transparent 60%),
          linear-gradient(180deg, var(--bg2), var(--bg));
      }

      .container {
        max-width: 1180px;
        margin: 0 auto;
        padding: 18px 16px 36px;
      }

      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .header {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }

      .title {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        min-width: 0;
      }

      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--unknown);
        box-shadow: 0 0 0 4px rgba(15, 23, 42, 0.06);
        flex: 0 0 auto;
      }

      h1 {
        margin: 0;
        font-size: 22px;
        letter-spacing: -0.02em;
      }

      .badge {
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.72);
        color: var(--text2);
        white-space: nowrap;
      }

      .sub {
        margin: 6px 0 0;
        font-size: 13px;
        color: var(--text3);
        max-width: 860px;
        line-height: 1.35;
      }

      .btn {
        appearance: none;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.80);
        color: var(--text2);
        border-radius: 999px;
        padding: 10px 12px;
        font-size: 13px;
        cursor: pointer;
        transition: transform 140ms ease, background 140ms ease, border-color 140ms ease, box-shadow 140ms ease;
        box-shadow: var(--shadow2);
      }
      .btn:hover {
        background: rgba(255, 255, 255, 0.95);
        transform: translateY(-1px);
      }
      .btn:active {
        transform: translateY(0px);
      }
      .btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .btn.primary {
        border-color: rgba(37, 99, 235, 0.25);
        box-shadow: 0 8px 18px rgba(37, 99, 235, 0.12);
      }

      .card {
        border: 1px solid var(--border);
        background: var(--card);
        border-radius: var(--r);
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .card .card-h {
        padding: 14px 14px 0;
      }
      .card .card-h h2 {
        margin: 0;
        font-size: 14px;
        font-weight: 700;
        color: var(--text2);
        letter-spacing: -0.01em;
      }
      .card .card-b {
        padding: 14px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
        margin-top: 14px;
      }

      @media (min-width: 980px) {
        .grid {
          grid-template-columns: repeat(12, 1fr);
        }
        .span-5 {
          grid-column: span 5;
        }
        .span-7 {
          grid-column: span 7;
        }
        .span-4 {
          grid-column: span 4;
        }
        .span-6 {
          grid-column: span 6;
        }
        .span-8 {
          grid-column: span 8;
        }
        .span-12 {
          grid-column: span 12;
        }
      }

      .help {
        border: 1px solid var(--border2);
        border-radius: var(--r);
        background: rgba(15, 23, 42, 0.03);
        padding: 12px;
        color: var(--text3);
        font-size: 12px;
        line-height: 1.35;
      }

      textarea {
        width: 100%;
        min-height: 220px;
        resize: vertical;
        border: 1px solid var(--border);
        border-radius: var(--r);
        padding: 12px;
        background: rgba(255, 255, 255, 0.9);
        color: var(--text);
        outline: none;
      }
      textarea:focus {
        box-shadow: 0 0 0 4px var(--focus);
        border-color: rgba(37, 99, 235, 0.35);
      }
      textarea::placeholder {
        color: rgba(15, 23, 42, 0.40);
      }

      .warn {
        border: 1px solid rgba(245, 158, 11, 0.35);
        background: rgba(245, 158, 11, 0.12);
        border-radius: var(--r);
        padding: 12px;
        color: rgba(66, 32, 6, 0.92);
        font-size: 13px;
      }
      .warn ul {
        margin: 6px 0 0;
        padding-left: 20px;
      }

      /* Filters layout: avoids overlap by allowing wrap + min-width */
      .filters {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
        align-items: end;
      }
      @media (min-width: 640px) {
        .filters {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      @media (min-width: 980px) {
        .filters {
          grid-template-columns: repeat(4, minmax(0, 1fr));
        }
      }

      label.small {
        display: block;
        font-size: 12px;
        color: var(--text3);
        margin-bottom: 6px;
      }

      input[type="date"],
      input[type="text"] {
        width: 100%;
        min-width: 0;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.92);
        color: var(--text);
        padding: 10px 10px;
        outline: none;
      }
      input[type="date"]:focus,
      input[type="text"]:focus {
        box-shadow: 0 0 0 4px var(--focus);
        border-color: rgba(37, 99, 235, 0.35);
      }

      .shift-box {
        border: 1px solid var(--border2);
        background: rgba(15, 23, 42, 0.03);
        border-radius: var(--r);
        padding: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
      }
      .shift-set {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }
      .shift {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text2);
      }
      .shift input {
        accent-color: rgba(37, 99, 235, 0.9);
      }

      .kpis {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }
      @media (min-width: 720px) {
        .kpis {
          grid-template-columns: repeat(4, minmax(0, 1fr));
        }
      }
      .kpi {
        border: 1px solid var(--border2);
        border-radius: var(--r);
        background: rgba(15, 23, 42, 0.03);
        padding: 12px;
        min-width: 0;
      }
      .kpi .k {
        font-size: 12px;
        color: var(--text3);
      }
      .kpi .v {
        margin-top: 6px;
        font-size: 18px;
        font-weight: 800;
        letter-spacing: -0.02em;
        color: var(--text);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .kpi .s {
        margin-top: 5px;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.25;
      }

      /* Tabs: more spacing, no overlap, horizontal scroll on small screens */
      .tabs {
        margin-top: 16px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.70);
        border-radius: var(--r);
        padding: 8px;
        display: flex;
        gap: 8px;
        overflow-x: auto;
        scrollbar-width: thin;
      }
      .tab {
        flex: 0 0 auto;
        padding: 10px 14px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: rgba(15, 23, 42, 0.05);
        color: var(--text2);
        font-size: 13px;
        cursor: pointer;
        transition: background 140ms ease, border-color 140ms ease, transform 140ms ease;
        white-space: nowrap;
      }
      .tab:hover {
        transform: translateY(-1px);
      }
      .tab.active {
        background: rgba(255, 255, 255, 0.92);
        border-color: rgba(15, 23, 42, 0.14);
      }

      .fade {
        animation: fadeIn 220ms ease-out both;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Charts: prevent overlap on very small screens */
      .chartWrap {
        height: 340px;
        min-height: 260px;
      }
      .chartWrap.small {
        height: 280px;
        min-height: 220px;
      }
      @media (max-width: 420px) {
        .chartWrap {
          height: 280px;
        }
        .chartWrap.small {
          height: 240px;
        }
      }
      canvas {
        width: 100% !important;
        height: 100% !important;
      }

      .insight {
        border: 1px solid var(--border2);
        border-radius: var(--r);
        background: rgba(15, 23, 42, 0.03);
        padding: 12px;
        color: var(--text2);
        font-size: 13px;
        line-height: 1.35;
      }
      .insight.muted {
        color: var(--text3);
      }

      .lists {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      @media (min-width: 760px) {
        .lists {
          grid-template-columns: 1fr 1fr;
        }
      }
      .list {
        border: 1px solid var(--border2);
        border-radius: var(--r);
        background: rgba(15, 23, 42, 0.03);
        overflow: hidden;
        min-width: 0;
      }
      .list .lh {
        padding: 10px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        border-bottom: 1px solid rgba(15, 23, 42, 0.06);
      }
      .list .lh .t {
        font-size: 13px;
        font-weight: 800;
        color: var(--text2);
      }
      .list .lb {
        max-height: 240px;
        overflow: auto;
      }
      .itemBtn {
        width: 100%;
        border: 0;
        background: transparent;
        color: inherit;
        padding: 10px 12px;
        text-align: left;
        cursor: pointer;
        border-top: 1px solid rgba(15, 23, 42, 0.06);
        transition: background 120ms ease;
      }
      .itemBtn:hover {
        background: rgba(15, 23, 42, 0.04);
      }
      .itemBtn.active {
        background: rgba(37, 99, 235, 0.08);
      }
      .itemTitle {
        font-size: 13px;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .itemMeta {
        margin-top: 4px;
        font-size: 11px;
        color: var(--text3);
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .tableWrap {
        border: 1px solid var(--border2);
        border-radius: var(--r);
        overflow: hidden;
        background: rgba(15, 23, 42, 0.03);
      }
      .tableScroll {
        max-height: 420px;
        overflow: auto;
        /* key fix: prevent columns from overlapping on narrow screens */
        overflow-x: auto;
      }
      table {
        width: 100%;
        min-width: 860px; /* allows horizontal scroll on phones instead of squeezing/overlapping */
        border-collapse: collapse;
      }
      thead {
        position: sticky;
        top: 0;
        backdrop-filter: blur(10px);
        background: rgba(248, 250, 252, 0.88);
      }
      th,
      td {
        padding: 10px 10px;
        border-bottom: 1px solid rgba(15, 23, 42, 0.06);
        font-size: 12px;
      }
      th {
        color: var(--text2);
        text-align: left;
      }
      td {
        color: var(--muted);
      }
      tr:hover td {
        background: rgba(15, 23, 42, 0.03);
      }
      .right {
        text-align: right;
        white-space: nowrap;
      }
      .nowrap {
        white-space: nowrap;
      }

      .foot {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 10px;
        padding: 10px 12px;
        font-size: 11px;
        color: var(--text3);
        background: rgba(255, 255, 255, 0.62);
        border-top: 1px solid rgba(15, 23, 42, 0.06);
      }

      .hr {
        height: 1px;
        background: rgba(15, 23, 42, 0.10);
        margin: 18px 0;
      }

      .hidden {
        display: none !important;
      }

      .fileInput {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div>
          <div class="title">
            <span id="lineDot" class="dot"></span>
            <h1>OEE Downtime Insights Dashboard</h1>
            <span id="activeBadge" class="badge">Line A</span>
          </div>
          <p class="sub">
            Paste Excel raw data (TSV) or upload a CSV. This prototype computes <b>end time</b> as
            <b>start + duration</b> (minutes) so you can see timestamps.
          </p>
        </div>
        <div class="row">
          <input id="fileInput" class="fileInput" type="file" accept=".csv,.txt" />
          <button id="btnUpload" class="btn">Upload CSV</button>
          <button id="btnSample" class="btn">Load sample</button>
          <button id="btnReset" class="btn">Reset</button>
        </div>
      </div>

      <div class="grid">
        <!-- Input -->
        <section class="card span-5">
          <div class="card-h"><h2>Paste raw data</h2></div>
          <div class="card-b">
            <div class="help">
              Best results: <b>Start Timestamp</b> OR <b>Date</b> + <b>Start Time</b>, plus <b>Shift</b>,
              <b>Line</b>, <b>Event/Reason</b>, <b>Duration (minutes)</b>, optional <b>Code</b>.
            </div>
            <div style="height: 10px"></div>
            <textarea id="rawText" placeholder="Paste from Excel here… (include header row)"></textarea>
            <div style="height: 10px"></div>
            <div class="row" style="align-items: center; justify-content: space-between">
              <div id="parseStatus" style="font-size: 12px; color: var(--text3)">Nothing parsed yet.</div>
              <button id="btnAnalyze" class="btn primary" disabled>Analyze</button>
            </div>
            <div id="warnings" class="warn hidden"></div>
          </div>
        </section>

        <!-- Filters + KPIs -->
        <section class="card span-7">
          <div class="card-h"><h2>Filters & KPIs</h2></div>
          <div class="card-b">
            <div class="filters">
              <div>
                <label class="small" for="dateFrom">From</label>
                <input id="dateFrom" type="date" disabled />
              </div>
              <div>
                <label class="small" for="dateTo">To</label>
                <input id="dateTo" type="date" disabled />
              </div>
              <div>
                <label class="small" for="search">Search</label>
                <input id="search" type="text" placeholder="event / code / shift…" disabled />
              </div>
              <div>
                <label class="small" for="codeQuery">Code filter</label>
                <input id="codeQuery" type="text" placeholder="e.g., CIP, E101…" disabled />
              </div>
            </div>

            <div style="height: 12px"></div>

            <div class="shift-box">
              <div class="shift-set">
                <span style="font-size: 12px; color: var(--text3)">Shifts:</span>
                <label class="shift"><input id="shA" type="checkbox" checked disabled /> A</label>
                <label class="shift"><input id="shB" type="checkbox" checked disabled /> B</label>
                <label class="shift"><input id="shC" type="checkbox" checked disabled /> C</label>
                <label class="shift"><input id="shD" type="checkbox" checked disabled /> D</label>
              </div>
              <div id="drill" style="font-size: 12px; color: var(--text3)">Tip: click an event in Top 10/5 to drill-down.</div>
            </div>

            <div style="height: 12px"></div>

            <div class="kpis">
              <div class="kpi">
                <div class="k">Downtime</div>
                <div id="kpiDowntime" class="v">—</div>
                <div id="kpiDowntimeSub" class="s">—</div>
              </div>
              <div class="kpi">
                <div class="k">Cost Impact</div>
                <div id="kpiCost" class="v">—</div>
                <div class="s">est. downtime cost</div>
              </div>
              <div class="kpi">
                <div class="k"># Events</div>
                <div id="kpiCount" class="v">—</div>
                <div id="kpiCountSub" class="s">—</div>
              </div>
              <div class="kpi">
                <div class="k">Top Event Share</div>
                <div id="kpiTopShare" class="v">—</div>
                <div id="kpiTopShareSub" class="s">—</div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Tabs -->
      <div class="tabs" role="tablist" aria-label="Lines">
        <button class="tab active" data-line="LINE A">Line A</button>
        <button class="tab" data-line="LINE B">Line B</button>
        <button class="tab" data-line="LINE C">Line C</button>
        <button class="tab" data-line="LINE D">Line D</button>
      </div>

      <!-- Dashboard -->
      <div id="dash" class="grid fade" style="margin-top: 14px">
        <section class="card span-8">
          <div class="card-h"><h2>Pareto: downtime by event (top 15)</h2></div>
          <div class="card-b">
            <div class="chartWrap"><canvas id="paretoChart"></canvas></div>
            <div style="height: 10px"></div>
            <div style="font-size: 12px; color: var(--text3)">
              Bars = downtime hours. Line = cumulative percentage.
            </div>
          </div>
        </section>

        <section class="card span-4">
          <div class="card-h"><h2>Key insights</h2></div>
          <div id="insights" class="card-b" style="display: flex; flex-direction: column; gap: 10px"></div>
        </section>

        <section class="card span-6">
          <div class="card-h"><h2>Downtime by shift</h2></div>
          <div class="card-b">
            <div class="chartWrap small"><canvas id="shiftChart"></canvas></div>
          </div>
        </section>

        <section class="card span-6">
          <div class="card-h"><h2>Top events</h2></div>
          <div class="card-b">
            <div class="lists">
              <div class="list">
                <div class="lh"><div class="t">Top 10</div><span id="top10Badge" class="badge">0 events</span></div>
                <div id="top10" class="lb"></div>
              </div>
              <div class="list">
                <div class="lh"><div class="t">Top 5</div><span id="top5Badge" class="badge">0 events</span></div>
                <div id="top5" class="lb"></div>
              </div>
            </div>
          </div>
        </section>

        <section class="card span-12">
          <div class="card-h"><h2>Event log</h2></div>
          <div class="card-b">
            <div class="tableWrap">
              <div class="tableScroll">
                <table>
                  <thead>
                    <tr>
                      <th class="nowrap">Date</th>
                      <th class="nowrap">Start</th>
                      <th class="nowrap">End</th>
                      <th>Shift</th>
                      <th>Line</th>
                      <th>Code</th>
                      <th>Event</th>
                      <th class="right">Downtime</th>
                      <th class="right">Cost</th>
                    </tr>
                  </thead>
                  <tbody id="logBody"></tbody>
                </table>
              </div>
              <div class="foot">
                <span id="logFoot">—</span>
                <button id="btnClearDrill" class="btn hidden" style="padding: 8px 10px">Clear drill-down</button>
              </div>
            </div>
          </div>
        </section>
      </div>

      <div class="hr"></div>

      <div style="font-size: 12px; color: var(--text3)">
        <div style="font-weight: 800; color: var(--text2)">Timestamp behavior</div>
        <div style="margin-top: 6px">
          This build rolls over end time into the next day when needed (e.g., <b>23:50</b> + <b>20 min</b> = <b>00:10</b>).
          If you want different behavior, tell me and I’ll adjust.
        </div>
      </div>
    </div>

    <script>
      // ---------------- Config ----------------
      const LINE_COLOR = {
        "LINE A": getComputedStyle(document.documentElement).getPropertyValue("--lineA").trim(),
        "LINE B": getComputedStyle(document.documentElement).getPropertyValue("--lineB").trim(),
        "LINE C": getComputedStyle(document.documentElement).getPropertyValue("--lineC").trim(),
        "LINE D": getComputedStyle(document.documentElement).getPropertyValue("--lineD").trim(),
        UNKNOWN: getComputedStyle(document.documentElement).getPropertyValue("--unknown").trim(),
      };

      const COST_PER_HOUR = {
        "LINE A": 1003.5,
        "LINE B": 1003.5,
        "LINE C": 1299.33,
        "LINE D": 1299.33,
      };

      const SHIFT_OPTIONS = ["A", "B", "C", "D"];

      // ---------------- State ----------------
      const state = {
        rawText: "",
        data: [],
        warnings: [],
        activeLine: "LINE A",
        dateFrom: "",
        dateTo: "",
        shifts: { A: true, B: true, C: true, D: true },
        search: "",
        codeQuery: "",
        selectedEventKey: null,
      };

      let paretoChart = null;
      let shiftChart = null;

      // ---------------- Helpers ----------------
      function clamp(n, min, max) {
        return Math.max(min, Math.min(max, n));
      }

      function round(n, dp = 2) {
        const p = Math.pow(10, dp);
        return Math.round(n * p) / p;
      }

      function fmtMoney(n) {
        if (!Number.isFinite(n)) return "$0";
        return n.toLocaleString(undefined, { style: "currency", currency: "USD" });
      }

      function fmtHoursFromMin(min) {
        const h = min / 60;
        return `${round(h, 2).toLocaleString()} h`;
      }

      function fmtMin(min) {
        return `${Math.round(min).toLocaleString()} min`;
      }

      function toISODate(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
      }

      function fmtTime(d) {
        if (!d) return "—";
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${hh}:${mm}`;
      }

      function tryParseNumber(s) {
        if (s == null) return null;
        const cleaned = String(s).trim().replace(/,/g, "").replace(/^\+/, "");
        if (!cleaned) return null;
        const n = Number(cleaned);
        return Number.isFinite(n) ? n : null;
      }

      function excelSerialToDate(serial) {
        const base = new Date(Date.UTC(1899, 11, 30));
        const ms = serial * 86400 * 1000;
        return new Date(base.getTime() + ms);
      }

      function tryParseDate(value) {
        if (!value) return null;
        const v = String(value).trim();

        const maybeNum = tryParseNumber(v);
        if (maybeNum != null && maybeNum > 20000 && maybeNum < 80000) {
          const d = excelSerialToDate(maybeNum);
          if (!Number.isNaN(d.getTime())) return d;
        }

        const d1 = new Date(v);
        if (!Number.isNaN(d1.getTime())) return d1;

        const m = v.match(
          /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/
        );
        if (m) {
          const mm = clamp(parseInt(m[1], 10), 1, 12);
          const dd = clamp(parseInt(m[2], 10), 1, 31);
          let yy = parseInt(m[3], 10);
          if (yy < 100) yy += 2000;
          const hh = m[4] ? clamp(parseInt(m[4], 10), 0, 23) : 0;
          const mi = m[5] ? clamp(parseInt(m[5], 10), 0, 59) : 0;
          const ss = m[6] ? clamp(parseInt(m[6], 10), 0, 59) : 0;
          const d = new Date(yy, mm - 1, dd, hh, mi, ss);
          if (!Number.isNaN(d.getTime())) return d;
        }

        return null;
      }

      function tryParseTimeOfDay(value) {
        if (!value) return null;
        const v = String(value).trim();
        if (!v) return null;

        const m = v.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
        if (m) {
          return {
            hours: clamp(parseInt(m[1], 10), 0, 23),
            minutes: clamp(parseInt(m[2], 10), 0, 59),
            seconds: m[3] ? clamp(parseInt(m[3], 10), 0, 59) : 0,
          };
        }

        const n = tryParseNumber(v);
        if (n != null && n >= 0 && n < 1.000001) {
          const totalSeconds = Math.round(n * 86400);
          const hours = clamp(Math.floor(totalSeconds / 3600), 0, 23);
          const minutes = clamp(Math.floor((totalSeconds % 3600) / 60), 0, 59);
          const seconds = clamp(totalSeconds % 60, 0, 59);
          return { hours, minutes, seconds };
        }

        return null;
      }

      function normalizeHeader(h) {
        return String(h)
          .trim()
          .toLowerCase()
          .replace(/\s+/g, " ")
          .replace(/[^a-z0-9 ]/g, "");
      }

      function normalizeLine(v) {
        const s = String(v || "").trim().toUpperCase();
        if (!s) return "UNKNOWN";
        if (s === "A" || s.includes("LINE A") || s === "LINEA") return "LINE A";
        if (s === "B" || s.includes("LINE B") || s === "LINEB") return "LINE B";
        if (s === "C" || s.includes("LINE C") || s === "LINEC") return "LINE C";
        if (s === "D" || s.includes("LINE D") || s === "LINED") return "LINE D";
        if (s.startsWith("A")) return "LINE A";
        if (s.startsWith("B")) return "LINE B";
        if (s.startsWith("C")) return "LINE C";
        if (s.startsWith("D")) return "LINE D";
        return s.startsWith("LINE ") ? s : "UNKNOWN";
      }

      function normalizeShift(v) {
        const s = String(v || "").trim().toUpperCase();
        if (SHIFT_OPTIONS.includes(s)) return s;
        for (const sh of SHIFT_OPTIONS) {
          if (s.includes(`SHIFT ${sh}`)) return sh;
        }
        return null;
      }

      function safeEventName(v) {
        const s = String(v || "").trim();
        if (!s) return "(Unspecified event)";
        return s.length > 140 ? s.slice(0, 137) + "…" : s;
      }

      function safeCode(v) {
        const s = String(v || "").trim();
        if (!s) return null;
        return s.length > 40 ? s.slice(0, 37) + "…" : s;
      }

      function getCostPerHour(line) {
        return COST_PER_HOUR[line] ?? 0;
      }

      function computeRowCostUSD(row) {
        return (row.downtimeMin / 60) * getCostPerHour(row.line);
      }

      function detectDelimiter(text) {
        return text.includes("\t") ? "\t" : ",";
      }

      function parseDelimited(text) {
        const normalized = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
        const lines = normalized
          .split("\n")
          .map((l) => l.replace(/\u00a0/g, " "))
          .filter((l) => l.trim().length > 0);
        if (lines.length === 0) return { headers: [], rows: [] };

        const delim = detectDelimiter(text);

        const splitLine = (line) => {
          if (delim === "\t") return line.split("\t");

          const out = [];
          let cur = "";
          let inQuotes = false;
          for (let i = 0; i < line.length; i++) {
            const ch = line[i];
            if (ch === '"') {
              if (inQuotes && line[i + 1] === '"') {
                cur += '"';
                i++;
              } else {
                inQuotes = !inQuotes;
              }
            } else if (ch === "," && !inQuotes) {
              out.push(cur);
              cur = "";
            } else {
              cur += ch;
            }
          }
          out.push(cur);
          return out;
        };

        const headers = splitLine(lines[0]).map((h) => h.trim());
        const rows = lines.slice(1).map((l) => splitLine(l).map((c) => c.trim()));
        return { headers, rows };
      }

      function mapColumns(headers) {
        const startDateTimeKeys = new Set([
          "start datetime",
          "start timestamp",
          "start time stamp",
          "timestamp",
          "datetime",
          "date time",
          "start date time",
          "start",
          "begin",
          "begin time",
        ]);

        const dateOnlyKeys = new Set(["date", "start date", "downtime date", "day"]);
        const timeOnlyKeys = new Set(["time", "start time", "begin time", "starttime", "begintime"]);

        const shiftKeys = new Set(["shift", "crew", "team"]);
        const lineKeys = new Set(["line", "asset", "area", "workcenter", "work center", "work centre", "equipment"]);
        const eventKeys = new Set(["event", "reason", "downtime reason", "fault", "stop reason", "stop category", "downtime event"]);
        const codeKeys = new Set(["code", "event code", "reason code", "downtime code", "fault code", "stop code"]);
        const durationKeys = new Set([
          "duration",
          "downtime",
          "minutes",
          "downtime minutes",
          "duration min",
          "duration minutes",
          "mins",
          "min",
          "time min",
          "time minutes",
        ]);

        const norm = headers.map(normalizeHeader);

        const pick = (keys) => {
          for (let i = 0; i < norm.length; i++) {
            if (keys.has(norm[i])) return i;
          }
          for (let i = 0; i < norm.length; i++) {
            const h = norm[i];
            for (const k of keys) {
              if (h.includes(k)) return i;
            }
          }
          return -1;
        };

        return {
          startDateTimeIdx: pick(startDateTimeKeys),
          dateIdx: pick(dateOnlyKeys),
          timeIdx: pick(timeOnlyKeys),
          shiftIdx: pick(shiftKeys),
          lineIdx: pick(lineKeys),
          eventIdx: pick(eventKeys),
          codeIdx: pick(codeKeys),
          durationIdx: pick(durationKeys),
        };
      }

      function buildRows(text) {
        const warnings = [];
        const { headers, rows } = parseDelimited(text);
        if (headers.length === 0) return { data: [], warnings: [] };

        const {
          startDateTimeIdx,
          dateIdx,
          timeIdx,
          shiftIdx,
          lineIdx,
          eventIdx,
          codeIdx,
          durationIdx,
        } = mapColumns(headers);

        if (startDateTimeIdx === -1 && dateIdx === -1) warnings.push("Could not detect a Date/Timestamp column.");
        if (lineIdx === -1) warnings.push("Could not detect a Line column.");
        if (eventIdx === -1) warnings.push("Could not detect an Event/Reason column.");
        if (durationIdx === -1) warnings.push("Could not detect a Duration/Minutes column.");

        const data = [];

        for (let r = 0; r < rows.length; r++) {
          const row = rows[r];
          const raw = {};
          for (let c = 0; c < headers.length; c++) raw[headers[c]] = row[c] ?? "";

          const durationMin = durationIdx >= 0 ? Math.max(0, tryParseNumber(row[durationIdx] ?? "") ?? 0) : 0;

          let startDt = null;
          if (startDateTimeIdx >= 0) startDt = tryParseDate(row[startDateTimeIdx] ?? "");

          if (!startDt && dateIdx >= 0 && timeIdx >= 0 && dateIdx !== timeIdx) {
            const datePart = tryParseDate(row[dateIdx] ?? "");
            const timePart = tryParseTimeOfDay(row[timeIdx] ?? "");
            if (datePart && timePart) {
              const combined = new Date(
                datePart.getFullYear(),
                datePart.getMonth(),
                datePart.getDate(),
                timePart.hours,
                timePart.minutes,
                timePart.seconds
              );
              startDt = Number.isNaN(combined.getTime()) ? null : combined;
            } else {
              const combinedText = `${row[dateIdx] ?? ""} ${row[timeIdx] ?? ""}`.trim();
              startDt = tryParseDate(combinedText);
            }
          }

          if (!startDt && dateIdx >= 0) startDt = tryParseDate(row[dateIdx] ?? "");

          const endDt = startDt && durationMin > 0 ? new Date(startDt.getTime() + durationMin * 60_000) : null;
          const dateISO = startDt ? toISODate(startDt) : null;

          const line = lineIdx >= 0 ? normalizeLine(row[lineIdx] ?? "") : "UNKNOWN";
          const shift = shiftIdx >= 0 ? normalizeShift(row[shiftIdx] ?? "") : null;
          const event = eventIdx >= 0 ? safeEventName(row[eventIdx] ?? "") : "(Unspecified event)";
          const code = codeIdx >= 0 ? safeCode(row[codeIdx] ?? "") : null;

          const isTrivial = !startDt && line === "UNKNOWN" && event === "(Unspecified event)" && durationMin === 0;
          if (isTrivial) continue;

          data.push({
            id: `${r}-${Math.random().toString(16).slice(2)}`,
            startDt,
            endDt,
            dateISO,
            shift,
            line,
            event,
            code,
            downtimeMin: durationMin,
            raw,
          });
        }

        if (data.length === 0) warnings.push("No usable rows found. Check that you pasted a header row + data.");
        return { data, warnings };
      }

      function sum(nums) {
        let s = 0;
        for (const n of nums) s += n;
        return s;
      }

      function percentile(val, total) {
        if (total <= 0) return 0;
        return (val / total) * 100;
      }

      function eventKey(row) {
        return row.code ? `${row.code} — ${row.event}` : row.event;
      }

      // ---------------- DOM ----------------
      const el = {
        lineDot: document.getElementById("lineDot"),
        activeBadge: document.getElementById("activeBadge"),
        rawText: document.getElementById("rawText"),
        parseStatus: document.getElementById("parseStatus"),
        warnings: document.getElementById("warnings"),
        btnAnalyze: document.getElementById("btnAnalyze"),
        btnReset: document.getElementById("btnReset"),
        btnUpload: document.getElementById("btnUpload"),
        btnSample: document.getElementById("btnSample"),
        fileInput: document.getElementById("fileInput"),
        dateFrom: document.getElementById("dateFrom"),
        dateTo: document.getElementById("dateTo"),
        search: document.getElementById("search"),
        codeQuery: document.getElementById("codeQuery"),
        shA: document.getElementById("shA"),
        shB: document.getElementById("shB"),
        shC: document.getElementById("shC"),
        shD: document.getElementById("shD"),
        drill: document.getElementById("drill"),
        btnClearDrill: document.getElementById("btnClearDrill"),
        kpiDowntime: document.getElementById("kpiDowntime"),
        kpiDowntimeSub: document.getElementById("kpiDowntimeSub"),
        kpiCost: document.getElementById("kpiCost"),
        kpiCount: document.getElementById("kpiCount"),
        kpiCountSub: document.getElementById("kpiCountSub"),
        kpiTopShare: document.getElementById("kpiTopShare"),
        kpiTopShareSub: document.getElementById("kpiTopShareSub"),
        insights: document.getElementById("insights"),
        top10: document.getElementById("top10"),
        top5: document.getElementById("top5"),
        top10Badge: document.getElementById("top10Badge"),
        top5Badge: document.getElementById("top5Badge"),
        logBody: document.getElementById("logBody"),
        logFoot: document.getElementById("logFoot"),
        dash: document.getElementById("dash"),
      };

      // ---------------- Rendering ----------------
      function setLineUI() {
        el.activeBadge.textContent = state.activeLine.replace("LINE ", "Line ");
        el.lineDot.style.background = LINE_COLOR[state.activeLine] ?? LINE_COLOR.UNKNOWN;
      }

      function enableControls(enabled) {
        el.dateFrom.disabled = !enabled;
        el.dateTo.disabled = !enabled;
        el.search.disabled = !enabled;
        el.codeQuery.disabled = !enabled;
        el.shA.disabled = !enabled;
        el.shB.disabled = !enabled;
        el.shC.disabled = !enabled;
        el.shD.disabled = !enabled;
      }

      function filteredRows() {
        const from = state.dateFrom ? new Date(state.dateFrom + "T00:00:00") : null;
        const to = state.dateTo ? new Date(state.dateTo + "T23:59:59") : null;
        const enabledShifts = SHIFT_OPTIONS.filter((s) => state.shifts[s]);
        const q = state.search.trim().toLowerCase();
        const cq = state.codeQuery.trim().toLowerCase();

        return state.data
          .filter((r) => {
            if (r.line !== state.activeLine) return false;

            if (enabledShifts.length < 4) {
              if (!r.shift) return false;
              if (!enabledShifts.includes(r.shift)) return false;
            }

            if (from || to) {
              if (!r.startDt) return false;
              if (from && r.startDt < from) return false;
              if (to && r.startDt > to) return false;
            }

            if (state.selectedEventKey && eventKey(r) !== state.selectedEventKey) return false;

            if (cq) {
              const hay = (r.code ?? "").toLowerCase();
              if (!hay.includes(cq)) return false;
            }

            if (q) {
              const hay = `${r.event} ${(r.code ?? "")} ${r.line} ${r.shift ?? ""} ${r.dateISO ?? ""}`.toLowerCase();
              if (!hay.includes(q)) return false;
            }

            return true;
          })
          .sort((a, b) => {
            const ta = a.startDt ? a.startDt.getTime() : -Infinity;
            const tb = b.startDt ? b.startDt.getTime() : -Infinity;
            return tb - ta;
          });
      }

      function aggregateByEvent(rows) {
        const map = new Map();
        for (const r of rows) {
          const key = eventKey(r);
          const cur = map.get(key) || {
            key,
            event: r.event,
            code: r.code,
            downtimeMin: 0,
            cost: 0,
            count: 0,
          };
          cur.downtimeMin += r.downtimeMin;
          cur.cost += computeRowCostUSD(r);
          cur.count += 1;
          map.set(key, cur);
        }

        const arr = Array.from(map.values()).sort((a, b) => b.downtimeMin - a.downtimeMin);

        const totalMin = sum(arr.map((d) => d.downtimeMin));
        let cum = 0;
        return arr.map((d) => {
          cum += d.downtimeMin;
          return {
            ...d,
            downtimeHours: d.downtimeMin / 60,
            pct: percentile(d.downtimeMin, totalMin),
            cumPct: percentile(cum, totalMin),
          };
        });
      }

      function aggregateByShift(rows) {
        const map = new Map();
        for (const r of rows) {
          const key = r.shift || "(Unknown)";
          const cur = map.get(key) || { shift: key, downtimeMin: 0, cost: 0 };
          cur.downtimeMin += r.downtimeMin;
          cur.cost += computeRowCostUSD(r);
          map.set(key, cur);
        }
        return Array.from(map.values())
          .map((d) => ({ ...d, downtimeHours: d.downtimeMin / 60 }))
          .sort((a, b) => b.downtimeMin - a.downtimeMin);
      }

      function renderWarnings() {
        if (!state.warnings.length) {
          el.warnings.classList.add("hidden");
          el.warnings.innerHTML = "";
          return;
        }
        el.warnings.classList.remove("hidden");
        el.warnings.innerHTML = `<div style="font-weight:800; margin-bottom:6px">Heads up</div><ul>${state.warnings
          .map((w) => `<li>${escapeHtml(w)}</li>`)
          .join("")}</ul>`;
      }

      function renderKPIs(rows, byEvent) {
        const totalMin = sum(rows.map((r) => r.downtimeMin));
        const totalCost = sum(rows.map((r) => computeRowCostUSD(r)));
        const eventCount = rows.length;
        const avgMin = eventCount ? totalMin / eventCount : 0;

        el.kpiDowntime.textContent = totalMin > 0 ? fmtHoursFromMin(totalMin) : "—";
        el.kpiDowntimeSub.textContent = totalMin > 0 ? `${fmtMin(totalMin)} total` : "—";

        el.kpiCost.textContent = totalMin > 0 ? fmtMoney(totalCost) : "—";

        el.kpiCount.textContent = eventCount ? eventCount.toLocaleString() : "—";
        el.kpiCountSub.textContent = eventCount ? `avg ${round(avgMin, 1)} min/event` : "—";

        const top = byEvent[0];
        el.kpiTopShare.textContent = top ? `${round(top.pct, 1)}%` : "—";
        el.kpiTopShareSub.textContent = top
          ? (top.code ? `${top.code} — ${top.event}` : top.event)
          : "no data";

        return { totalMin, totalCost, eventCount, avgMin };
      }

      function renderInsights(hasData, totals, byEvent, byShift) {
        const out = [];
        if (!hasData || totals.totalMin <= 0) {
          out.push({ text: "Paste or upload a dataset to generate insights.", muted: true });
        } else {
          const top = byEvent[0];
          if (top) {
            const name = top.code ? `${top.code} — ${top.event}` : top.event;
            out.push({
              text: `#1 event: “${name}” accounts for ${round(top.pct, 1)}% of downtime (${fmtHoursFromMin(
                top.downtimeMin
              )}, ${fmtMoney(top.cost)}).`,
            });
          }

          const top3 = byEvent.slice(0, 3);
          if (top3.length >= 2) {
            const top3Min = sum(top3.map((d) => d.downtimeMin));
            out.push({
              text: `Top 3 events drive ${round(percentile(top3Min, totals.totalMin), 1)}% of downtime — ideal for focused RCA + countermeasures.`,
            });
          }

          const worstShift = byShift[0];
          if (worstShift && byShift.length > 1) {
            out.push({
              text: `Shift with highest downtime: ${worstShift.shift} (${fmtHoursFromMin(
                worstShift.downtimeMin
              )}). Compare staffing, changeovers, and maintenance windows.`,
            });
          }

          const idx80 = byEvent.findIndex((d) => d.cumPct >= 80);
          if (idx80 >= 0) {
            out.push({
              text: `Pareto focus: first ${idx80 + 1} events get you to ~80% of downtime reduction opportunity (within this filter).`,
            });
          }

          out.push({ text: `Estimated downtime cost: ${fmtMoney(totals.totalCost)} for the currently filtered window.` });
          out.push({
            text: `Downtime cost rates: Line A/B = $1,003.50/hr; Line C/D = $1,299.33/hr.`,
            muted: true,
          });
        }

        el.insights.innerHTML = out
          .map(
            (d) =>
              `<div class="insight ${d.muted ? "muted" : ""}">${escapeHtml(d.text)}</div>`
          )
          .join("");
      }

      function renderTopLists(byEvent) {
        const top10 = byEvent.slice(0, 10);
        const top5 = byEvent.slice(0, 5);

        el.top10Badge.textContent = `${top10.length} events`;
        el.top5Badge.textContent = `${top5.length} events`;

        el.top10.innerHTML = top10.length ? top10.map((d, i) => renderTopItem(d, i)).join("") : emptyList();
        el.top5.innerHTML = top5.length ? top5.map((d, i) => renderTopItem(d, i)).join("") : emptyList();

        for (const root of [el.top10, el.top5]) {
          root.querySelectorAll("button[data-ev]").forEach((btn) => {
            btn.addEventListener("click", () => {
              state.selectedEventKey = btn.getAttribute("data-ev");
              persistFilters();
              renderAll();
            });
          });
        }
      }

      function emptyList() {
        return `<div style="padding: 18px 12px; text-align:center; color: var(--text3); font-size: 13px">No events.</div>`;
      }

      function renderTopItem(d, idx) {
        const pct = round(d.pct, 1);
        const label = d.code ? `${d.code} — ${d.event}` : d.event;
        const isActive = state.selectedEventKey === d.key;
        return `
          <button class="itemBtn ${isActive ? "active" : ""}" data-ev="${escapeAttr(d.key)}" title="${escapeAttr(label)}">
            <div class="itemTitle">#${idx + 1} ${escapeHtml(label)}</div>
            <div class="itemMeta">
              <span>${escapeHtml(fmtHoursFromMin(d.downtimeMin))}</span>
              <span>•</span>
              <span>${escapeHtml(fmtMoney(d.cost))}</span>
              <span>•</span>
              <span>${pct}%</span>
              <span>•</span>
              <span>${d.count} stops</span>
            </div>
          </button>
        `;
      }

      function renderLog(rows) {
        const cap = 300;
        const shown = rows.slice(0, cap);

        el.logBody.innerHTML = shown
          .map((r) => {
            const cost = computeRowCostUSD(r);
            const lc = LINE_COLOR[r.line] ?? LINE_COLOR.UNKNOWN;
            return `
              <tr>
                <td class="nowrap">${escapeHtml(r.dateISO ?? "—")}</td>
                <td class="nowrap">${escapeHtml(fmtTime(r.startDt))}</td>
                <td class="nowrap">${escapeHtml(fmtTime(r.endDt))}</td>
                <td>${escapeHtml(r.shift ?? "—")}</td>
                <td class="nowrap"><span style="display:inline-flex; align-items:center; gap:8px"><span style="width:8px;height:8px;border-radius:999px;background:${lc}"></span>${escapeHtml(r.line.replace("LINE ", "Line "))}</span></td>
                <td>${escapeHtml(r.code ?? "—")}</td>
                <td>${escapeHtml(r.event)}</td>
                <td class="right">${escapeHtml(fmtMin(r.downtimeMin))}</td>
                <td class="right">${escapeHtml(fmtMoney(cost))}</td>
              </tr>
            `;
          })
          .join("");

        el.logFoot.textContent = `Showing ${Math.min(rows.length, cap).toLocaleString()} of ${rows.length.toLocaleString()} rows (cap for performance).`;

        if (state.selectedEventKey) {
          el.btnClearDrill.classList.remove("hidden");
          el.drill.innerHTML = `Drill-down: <span class="badge" style="padding:4px 8px">${escapeHtml(state.selectedEventKey)}</span>`;
        } else {
          el.btnClearDrill.classList.add("hidden");
          el.drill.textContent = "Tip: click an event in Top 10/5 to drill-down.";
        }
      }

      function renderCharts(byEvent, byShift) {
        // Light-theme chart styling
        const axisGrid = "rgba(15,23,42,0.08)";
        const tickColor = "rgba(15,23,42,0.72)";
        const titleColor = "rgba(15,23,42,0.82)";

        const pareto = byEvent.slice(0, 15);
        const labels = pareto.map((d, idx) => `#${idx + 1}`);
        const barData = pareto.map((d) => round(d.downtimeHours, 3));
        const lineData = pareto.map((d) => round(d.cumPct, 3));

        const paretoCtx = document.getElementById("paretoChart");
        if (paretoChart) paretoChart.destroy();

        paretoChart = new Chart(paretoCtx, {
          data: {
            labels,
            datasets: [
              {
                type: "bar",
                label: "Downtime (hours)",
                data: barData,
                backgroundColor: "rgba(15,23,42,0.14)",
                borderColor: "rgba(15,23,42,0.14)",
                borderWidth: 1,
                borderRadius: 10,
                yAxisID: "y",
              },
              {
                type: "line",
                label: "Cumulative %",
                data: lineData,
                borderColor: "rgba(15,23,42,0.78)",
                backgroundColor: "rgba(15,23,42,0.78)",
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.25,
                yAxisID: "y1",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: {
                backgroundColor: "rgba(255,255,255,0.96)",
                borderColor: "rgba(15,23,42,0.14)",
                borderWidth: 1,
                titleColor: "rgba(15,23,42,0.92)",
                bodyColor: "rgba(15,23,42,0.80)",
                callbacks: {
                  title: (items) => {
                    const i = items?.[0]?.dataIndex ?? 0;
                    const row = pareto[i];
                    if (!row) return "";
                    const label = row.code ? `${row.code} — ${row.event}` : row.event;
                    return `#${i + 1} • ${label}`;
                  },
                  label: (ctx) => {
                    if (ctx.dataset.type === "line") return `Cumulative: ${round(ctx.raw, 1)}%`;
                    return `Downtime: ${round(ctx.raw, 2)} h`;
                  },
                },
              },
              legend: {
                labels: { color: titleColor },
              },
            },
            scales: {
              x: {
                ticks: { color: tickColor },
                grid: { color: axisGrid },
              },
              y: {
                position: "left",
                ticks: { color: tickColor },
                grid: { color: axisGrid },
                title: { display: true, text: "Hours", color: titleColor },
              },
              y1: {
                position: "right",
                min: 0,
                max: 100,
                ticks: { color: tickColor, callback: (v) => v + "%" },
                grid: { drawOnChartArea: false },
                title: { display: true, text: "Cumulative %", color: titleColor },
              },
            },
          },
        });

        const shiftCtx = document.getElementById("shiftChart");
        if (shiftChart) shiftChart.destroy();

        shiftChart = new Chart(shiftCtx, {
          type: "bar",
          data: {
            labels: byShift.map((d) => d.shift),
            datasets: [
              {
                label: "Downtime (hours)",
                data: byShift.map((d) => round(d.downtimeHours, 3)),
                backgroundColor: LINE_COLOR[state.activeLine] ?? "rgba(15,23,42,0.14)",
                borderRadius: 10,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: titleColor } },
              tooltip: {
                backgroundColor: "rgba(255,255,255,0.96)",
                borderColor: "rgba(15,23,42,0.14)",
                borderWidth: 1,
                titleColor: "rgba(15,23,42,0.92)",
                bodyColor: "rgba(15,23,42,0.80)",
                callbacks: {
                  label: (ctx) => `Downtime: ${round(ctx.raw, 2)} h`,
                },
              },
            },
            scales: {
              x: { ticks: { color: tickColor }, grid: { color: axisGrid } },
              y: { ticks: { color: tickColor }, grid: { color: axisGrid } },
            },
          },
        });
      }

      function renderAll() {
        setLineUI();

        el.dash.classList.remove("fade");
        void el.dash.offsetWidth;
        el.dash.classList.add("fade");

        renderWarnings();

        const hasData = state.data.length > 0;
        enableControls(hasData);

        el.shA.checked = state.shifts.A;
        el.shB.checked = state.shifts.B;
        el.shC.checked = state.shifts.C;
        el.shD.checked = state.shifts.D;

        const rows = hasData ? filteredRows() : [];
        const byEvent = aggregateByEvent(rows);
        const byShift = aggregateByShift(rows);

        const totals = renderKPIs(rows, byEvent);
        renderInsights(hasData, totals, byEvent, byShift);
        renderTopLists(byEvent);
        renderLog(rows);

        if (hasData) renderCharts(byEvent, byShift);
        else {
          if (paretoChart) paretoChart.destroy();
          if (shiftChart) shiftChart.destroy();
          paretoChart = null;
          shiftChart = null;
        }

        if (state.data.length) {
          el.parseStatus.innerHTML = `Parsed <b>${state.data.length.toLocaleString()}</b> rows.`;
        } else {
          el.parseStatus.textContent = "Nothing parsed yet.";
        }
      }

      // ---------------- Persistence ----------------
      function persistText() {
        try {
          localStorage.setItem("oee_html_text_v1", state.rawText);
        } catch {}
      }

      function persistFilters() {
        try {
          localStorage.setItem(
            "oee_html_filters_v1",
            JSON.stringify({
              activeLine: state.activeLine,
              dateFrom: state.dateFrom,
              dateTo: state.dateTo,
              shifts: state.shifts,
              search: state.search,
              codeQuery: state.codeQuery,
              selectedEventKey: state.selectedEventKey,
            })
          );
        } catch {}
      }

      function loadPersisted() {
        try {
          const saved = localStorage.getItem("oee_html_text_v1");
          const f = localStorage.getItem("oee_html_filters_v1");
          if (saved) {
            state.rawText = saved;
            el.rawText.value = saved;
            const built = buildRows(saved);
            state.data = built.data;
            state.warnings = built.warnings;
          }
          if (f) {
            const parsed = JSON.parse(f);
            if (parsed?.activeLine) state.activeLine = parsed.activeLine;
            if (parsed?.dateFrom != null) state.dateFrom = parsed.dateFrom;
            if (parsed?.dateTo != null) state.dateTo = parsed.dateTo;
            if (parsed?.shifts) state.shifts = parsed.shifts;
            if (parsed?.search != null) state.search = parsed.search;
            if (parsed?.codeQuery != null) state.codeQuery = parsed.codeQuery;
            if (parsed?.selectedEventKey != null) state.selectedEventKey = parsed.selectedEventKey;
          }
        } catch {}

        el.dateFrom.value = state.dateFrom;
        el.dateTo.value = state.dateTo;
        el.search.value = state.search;
        el.codeQuery.value = state.codeQuery;
        el.shA.checked = state.shifts.A;
        el.shB.checked = state.shifts.B;
        el.shC.checked = state.shifts.C;
        el.shD.checked = state.shifts.D;

        if (state.rawText.trim().length >= 10) el.btnAnalyze.disabled = false;

        if (state.data.length) ensureDateRangeFromData();

        syncTabButtons();
      }

      function ensureDateRangeFromData() {
        const ts = state.data
          .map((r) => r.startDt)
          .filter(Boolean)
          .map((d) => d.getTime());
        if (!ts.length) return;
        const minD = new Date(Math.min(...ts));
        const maxD = new Date(Math.max(...ts));
        const minISO = toISODate(minD);
        const maxISO = toISODate(maxD);
        if (!state.dateFrom) state.dateFrom = minISO;
        if (!state.dateTo) state.dateTo = maxISO;
        el.dateFrom.value = state.dateFrom;
        el.dateTo.value = state.dateTo;
      }

      // ---------------- Events ----------------
      el.rawText.addEventListener("input", () => {
        state.rawText = el.rawText.value;
        el.btnAnalyze.disabled = state.rawText.trim().length < 10;
        persistText();
      });

      el.btnAnalyze.addEventListener("click", () => {
        const built = buildRows(state.rawText);
        state.data = built.data;
        state.warnings = built.warnings;
        state.selectedEventKey = null;

        ensureDateRangeFromData();

        persistText();
        persistFilters();
        renderAll();
      });

      el.btnReset.addEventListener("click", () => {
        state.rawText = "";
        state.data = [];
        state.warnings = [];
        state.activeLine = "LINE A";
        state.dateFrom = "";
        state.dateTo = "";
        state.shifts = { A: true, B: true, C: true, D: true };
        state.search = "";
        state.codeQuery = "";
        state.selectedEventKey = null;

        el.rawText.value = "";
        el.dateFrom.value = "";
        el.dateTo.value = "";
        el.search.value = "";
        el.codeQuery.value = "";

        try {
          localStorage.removeItem("oee_html_text_v1");
          localStorage.removeItem("oee_html_filters_v1");
        } catch {}

        syncTabButtons();
        renderAll();
      });

      el.btnUpload.addEventListener("click", () => el.fileInput.click());
      el.fileInput.addEventListener("change", async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        const text = await f.text();
        state.rawText = text;
        el.rawText.value = text;

        const built = buildRows(text);
        state.data = built.data;
        state.warnings = built.warnings;
        state.selectedEventKey = null;

        ensureDateRangeFromData();

        persistText();
        persistFilters();
        renderAll();

        e.target.value = "";
      });

      el.btnSample.addEventListener("click", () => {
        const sample = makeSampleData();
        state.rawText = sample;
        el.rawText.value = sample;

        const built = buildRows(sample);
        state.data = built.data;
        state.warnings = built.warnings;
        state.selectedEventKey = null;

        ensureDateRangeFromData();

        persistText();
        persistFilters();
        renderAll();
      });

      el.dateFrom.addEventListener("change", () => {
        state.dateFrom = el.dateFrom.value;
        persistFilters();
        renderAll();
      });
      el.dateTo.addEventListener("change", () => {
        state.dateTo = el.dateTo.value;
        persistFilters();
        renderAll();
      });
      el.search.addEventListener("input", () => {
        state.search = el.search.value;
        persistFilters();
        renderAll();
      });
      el.codeQuery.addEventListener("input", () => {
        state.codeQuery = el.codeQuery.value;
        persistFilters();
        renderAll();
      });

      function bindShift(id, key) {
        document.getElementById(id).addEventListener("change", (e) => {
          state.shifts[key] = Boolean(e.target.checked);
          persistFilters();
          renderAll();
        });
      }
      bindShift("shA", "A");
      bindShift("shB", "B");
      bindShift("shC", "C");
      bindShift("shD", "D");

      el.btnClearDrill.addEventListener("click", () => {
        state.selectedEventKey = null;
        persistFilters();
        renderAll();
      });

      document.querySelectorAll(".tab").forEach((btn) => {
        btn.addEventListener("click", () => {
          state.activeLine = btn.getAttribute("data-line");
          state.selectedEventKey = null;
          persistFilters();
          syncTabButtons();
          renderAll();
        });
      });

      function syncTabButtons() {
        document.querySelectorAll(".tab").forEach((b) => b.classList.remove("active"));
        const activeBtn = document.querySelector(`.tab[data-line="${state.activeLine}"]`);
        if (activeBtn) activeBtn.classList.add("active");
      }

      // ---------------- Sample data ----------------
      function makeSampleData() {
        const headers = [
          "Date",
          "Start Time",
          "Shift",
          "Line",
          "Code",
          "Event",
          "Duration (minutes)",
        ];

        const lines = ["LINE A", "LINE B", "LINE C", "LINE D"];
        const shifts = ["A", "B", "C", "D"];
        const events = [
          { code: "CIP", event: "Unplanned CIP" },
          { code: "MB01", event: "Material blockage" },
          { code: "FB", event: "Film break" },
          { code: "SN01", event: "Sensor fault" },
          { code: "JW", event: "Jam at wrapper" },
          { code: "CHG", event: "Changeover support" },
          { code: "QC", event: "Quality hold check" },
          { code: "MTN", event: "Maintenance adjustment" },
        ];

        const start = new Date();
        start.setDate(start.getDate() - 10);

        const rows = [];
        for (let i = 0; i < 220; i++) {
          const d = new Date(start.getTime() + Math.floor(Math.random() * 10) * 86400_000);
          const date = toISODate(d);
          const hh = String(Math.floor(Math.random() * 24)).padStart(2, "0");
          const mm = String(Math.floor(Math.random() * 60)).padStart(2, "0");

          const line = lines[Math.floor(Math.random() * lines.length)];
          const shift = shifts[Math.floor(Math.random() * shifts.length)];
          const ev = events[Math.floor(Math.random() * events.length)];

          let dur = Math.floor(5 + Math.random() * 45);
          if (ev.code === "CIP") dur = Math.floor(18 + Math.random() * 90);
          if (ev.code === "MB01") dur = Math.floor(10 + Math.random() * 55);
          if (ev.code === "FB") dur = Math.floor(6 + Math.random() * 35);

          rows.push([date, `${hh}:${mm}`, shift, line, ev.code, ev.event, String(dur)].join("\t"));
        }

        return headers.join("\t") + "\n" + rows.join("\n") + "\n";
      }

      // ---------------- Escaping ----------------
      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
      function escapeAttr(s) {
        return escapeHtml(s).replaceAll("`", "&#096;");
      }

      // ---------------- Boot ----------------
      loadPersisted();
      if (el.rawText.value.trim().length >= 10) el.btnAnalyze.disabled = false;
      if (state.data.length) enableControls(true);
      renderAll();
    </script>
  </body>
</html>
